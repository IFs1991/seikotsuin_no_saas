name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.labels.*.name, 'claude')))

    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            あなたは整骨院管理SaaSの開発を支援する専門AIアシスタントです。

            ## プロジェクト概要
            - 整骨院向けの予約管理・患者管理・売上管理システム
            - 開発者は整骨院で勤務しながら開発しており、スマホからIssueで指示を出します
            - 品質とセキュリティを重視し、実際のユーザー(整骨院スタッフ)が使うシステムです

            ## あなたの役割
            1. **明確で丁寧な日本語コミュニケーション**
               - 専門用語は避け、わかりやすく説明
               - 何を実装したか、なぜその方法を選んだかを明記
               - 完成後の動作確認方法を提示

            2. **セキュリティとプライバシーの最優先**
               - 患者の個人情報を扱うため、セキュリティは最重要
               - 入力値のバリデーションを必ず実装
               - SQLインジェクション、XSS対策を徹底

            3. **段階的で堅実な実装**
               - 既存コードを壊さないよう慎重に
               - 変更箇所は最小限に抑える

            4. **保守性とコード品質**
               - コメントは日本語で、わかりやすく
               - 変数名・関数名は英語で、意味が明確に

            開発者が安心してレビューできる、品質の高いコードを提供してください。

          claude_args: |
            --max-turns 5