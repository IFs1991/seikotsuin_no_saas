# スキーマ変更した内容

## 概要
- **実施日**: 2024-01-15
- **目的**: フロントエンドのモック部分を実データ連携に変更するため、Supabaseのスキーマを統一
- **作業者**: Claude Code Assistant

## 現状分析

### 発見された問題
1. **スキーマの重複**: 2つの異なるテーブル構造が存在
   - メインスキーマ: `/src/database/schemas/` 
   - 代替スキーマ: `/src/api/database/schema.sql`

2. **テーブル名の不一致**:
   - メイン: `treatment_menus`, `ai_comments`, `treatment_menu_records`
   - 代替: `master_treatment_menus`, `daily_ai_comments`

3. **アプリケーションコードとDBの不整合**:
   - フロントエンドコードはメインスキーマを期待
   - 実際のDBには代替スキーマが適用されている

## 必要な対応（手動作業が必要）

### Step 1: Supabaseダッシュボードでのスキーマ適用

Supabaseダッシュボード（https://supabase.com/dashboard/project/eeczntsiyehoygsptksh）の「SQL Editor」で以下のファイルを順番に実行する必要があります：

#### 1. メニューカテゴリテーブル作成
```sql
-- src/database/schemas/02_master_data.sql の 37-49行目
CREATE TABLE public.menu_categories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    color_code VARCHAR(7) DEFAULT '#3B82F6',
    icon_name VARCHAR(50),
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 2. 施術メニューテーブル作成
```sql
-- src/database/schemas/02_master_data.sql の 10-34行目
CREATE TABLE public.treatment_menus (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES public.clinics(id) ON DELETE CASCADE,
    category_id UUID REFERENCES public.menu_categories(id),
    code VARCHAR(50),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(8, 2) NOT NULL CHECK (price >= 0),
    duration_minutes INTEGER DEFAULT 30 CHECK (duration_minutes > 0),
    is_insurance_applicable BOOLEAN DEFAULT false,
    insurance_points INTEGER,
    max_sessions_per_day INTEGER,
    required_qualifications TEXT[],
    body_parts TEXT[],
    treatment_type VARCHAR(50),
    equipment_required TEXT[],
    contraindications TEXT[],
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT treatment_menus_code_clinic_unique UNIQUE (clinic_id, code)
);
```

#### 3. 施術メニュー実績テーブル作成
```sql
-- src/database/schemas/03_transaction_tables.sql の 85-99行目
CREATE TABLE public.treatment_menu_records (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    treatment_id UUID NOT NULL REFERENCES public.treatments(id) ON DELETE CASCADE,
    menu_id UUID NOT NULL REFERENCES public.treatment_menus(id) ON DELETE RESTRICT,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(8, 2) NOT NULL,
    total_price DECIMAL(8, 2) NOT NULL,
    insurance_points INTEGER,
    insurance_coverage_amount DECIMAL(8, 2),
    patient_payment_amount DECIMAL(8, 2),
    duration_minutes INTEGER,
    performed_by UUID REFERENCES public.staff(id),
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 4. AIコメントテーブル作成
```sql
-- src/database/schemas/03_transaction_tables.sql の 200-232行目
CREATE TABLE public.ai_comments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID NOT NULL REFERENCES public.clinics(id) ON DELETE CASCADE,
    daily_report_id UUID REFERENCES public.daily_reports(id) ON DELETE CASCADE,
    comment_date DATE NOT NULL,
    comment_type VARCHAR(50) DEFAULT 'daily_summary',
    summary TEXT NOT NULL,
    good_points TEXT[],
    improvement_points TEXT[],
    recommendations TEXT[],
    alerts TEXT[],
    insights TEXT[],
    ai_model_version VARCHAR(50),
    confidence_score DECIMAL(3, 2),
    data_sources TEXT[],
    analysis_parameters JSONB,
    raw_ai_response JSONB,
    user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5),
    user_feedback TEXT,
    is_helpful BOOLEAN,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT ai_comments_clinic_date_type_unique UNIQUE (clinic_id, comment_date, comment_type)
);
```

#### 5. インデックス作成
```sql
-- treatment_menusテーブル
CREATE INDEX idx_treatment_menus_clinic_id ON public.treatment_menus(clinic_id);
CREATE INDEX idx_treatment_menus_category ON public.treatment_menus(category_id);
CREATE INDEX idx_treatment_menus_active ON public.treatment_menus(is_active);
CREATE INDEX idx_treatment_menus_price ON public.treatment_menus(price);

-- treatment_menu_recordsテーブル
CREATE INDEX idx_treatment_menu_records_treatment ON public.treatment_menu_records(treatment_id);
CREATE INDEX idx_treatment_menu_records_menu ON public.treatment_menu_records(menu_id);
CREATE INDEX idx_treatment_menu_records_staff ON public.treatment_menu_records(performed_by);

-- ai_commentsテーブル
CREATE INDEX idx_ai_comments_clinic_date ON public.ai_comments(clinic_id, comment_date);
CREATE INDEX idx_ai_comments_type ON public.ai_comments(comment_type);
CREATE INDEX idx_ai_comments_confidence ON public.ai_comments(confidence_score);
```

### Step 2: サンプルデータ投入（オプション）

開発・テスト用のサンプルデータが必要な場合：

#### メニューカテゴリ
```sql
INSERT INTO public.menu_categories (name, description, color_code, display_order) VALUES
('整体・矯正', '骨格や筋肉の調整を行う施術', '#3B82F6', 1),
('鍼灸', '鍼や灸を使用した伝統的な治療', '#10B981', 2),
('マッサージ', 'リラクゼーションや筋肉のほぐし', '#F59E0B', 3),
('機器治療', '電気治療器などを使用した施術', '#EF4444', 4);
```

#### 施術メニュー
```sql
INSERT INTO public.treatment_menus (clinic_id, name, price, duration_minutes, description) VALUES
('22222222-2222-2222-2222-222222222222', '全身調整', 4000, 60, '全身の骨格バランスを整える施術'),
('22222222-2222-2222-2222-222222222222', '骨盤矯正', 3500, 45, '骨盤の歪みを矯正する施術'),
('22222222-2222-2222-2222-222222222222', '鍼治療', 3000, 30, '鍼を使用した痛みの緩和治療'),
('22222222-2222-2222-2222-222222222222', '電気治療', 2000, 20, '低周波治療器による筋肉刺激'),
('22222222-2222-2222-2222-222222222222', 'マッサージ', 2500, 30, 'リラクゼーションマッサージ');
```

## 影響範囲

### 1. フロントエンドコンポーネント
以下のコンポーネントが実データ連携可能になります：

- `src/components/revenue/menu-ranking.tsx` - 施術メニューランキング
- `src/components/dashboard/ai-comment-card.tsx` - AIコメント表示
- `src/app/ai-insights/page.tsx` - AI分析画面

### 2. API エンドポイント
新たに作成が必要なAPIエンドポイント：

- `/api/revenue/menu-ranking` - メニュー別売上ランキング取得
- `/api/ai-comments` - AIコメント取得・更新
- `/api/treatment-menus` - 施術メニュー管理

### 3. 型定義
`src/types/index.ts`に追加が必要な型：

```typescript
export interface TreatmentMenu {
  id: string;
  clinic_id: string;
  name: string;
  price: number;
  duration_minutes: number;
  description?: string;
  is_active: boolean;
  created_at: string;
}

export interface TreatmentMenuRecord {
  id: string;
  treatment_id: string;
  menu_id: string;
  quantity: number;
  unit_price: number;
  total_price: number;
  created_at: string;
}

export interface MenuRankingData {
  id: string;
  name: string;
  revenue: number;
  usage: number;
  unitPrice: number;
  prevPeriod: number;
}
```

## 作業ステータス

- ✅ 問題の特定・分析完了
- ✅ 必要なSQL文の準備完了
- ❌ **手動でのスキーマ適用が必要**（Supabaseダッシュボードで実行）
- ⏸️ サンプルデータ投入（スキーマ適用後）
- ⏸️ フロントエンド実装（スキーマ適用後）

## 次回作業時の引き継ぎ事項

### 最優先タスク
1. **Supabaseでの手動スキーマ適用**
   - 上記Step 1のSQL文をSupabaseダッシュボードで実行
   - エラーが発生した場合は依存関係を確認

2. **接続確認**
   - テーブル作成後、接続テストを再実行
   - サンプルデータの投入

3. **施術メニューランキング実装**
   - APIエンドポイント作成
   - フロントエンドのモック部分を実データ連携に変更

### 懸念事項
- **既存データとの競合**: 現在の`master_treatment_menus`テーブルにデータが存在する場合、移行が必要
- **RLS設定**: Row Level Securityの設定が必要（認証されたユーザーのみアクセス可能）
- **外部キー制約**: `treatments`テーブルが存在しない場合、`treatment_menu_records`作成時にエラーが発生する可能性

## 成功基準
- [ ] `treatment_menus`, `treatment_menu_records`, `ai_comments`テーブルが正常に作成される
- [ ] フロントエンドから実データを取得できる
- [ ] 施術メニューランキングが実際の売上データで表示される
- [ ] AIコメント機能が動作する

---

**重要**: このドキュメントは作業の継続性を保つためのものです。スキーマ変更は慎重に行い、本番環境では必ずバックアップを取得してから実施してください。