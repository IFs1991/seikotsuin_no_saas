# äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025-11-04
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**å¯¾è±¡**: æ•´éª¨é™¢ç®¡ç†SaaS äºˆç´„æ©Ÿèƒ½

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
3. [ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ](#ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ)
4. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †](#ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †)
5. [ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ](#ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ )
6. [RLSãƒãƒªã‚·ãƒ¼](#rlsãƒãƒªã‚·ãƒ¼)
7. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
8. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †)

---

## ğŸ¯ æ¦‚è¦

ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«å¿…è¦ãªä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦ç´ ã‚’ä½œæˆã—ã¾ã™ï¼š

### ä½œæˆã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

| ã‚«ãƒ†ã‚´ãƒª | æ•° | è©³ç´° |
|---------|---|------|
| **ãƒ†ãƒ¼ãƒ–ãƒ«** | 6 | customers, menus, resources, reservations, blocks, reservation_history |
| **ãƒ“ãƒ¥ãƒ¼** | 1 | reservation_list_viewï¼ˆJOINæ¸ˆã¿äºˆç´„ä¸€è¦§ï¼‰ |
| **ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼** | 1 | daily_reservation_statsï¼ˆæ—¥åˆ¥çµ±è¨ˆï¼‰ |
| **é–¢æ•°** | 8 | è¡çªãƒã‚§ãƒƒã‚¯ã€æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆã€å±¥æ­´è¨˜éŒ²ç­‰ |
| **ãƒˆãƒªã‚¬ãƒ¼** | 9 | è‡ªå‹•æ›´æ–°ã€å±¥æ­´è¨˜éŒ² |
| **RLSãƒãƒªã‚·ãƒ¼** | 25 | ãƒ­ãƒ¼ãƒ«åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ |
| **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹** | 40+ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– |

### å®Ÿè£…æ©Ÿèƒ½

- âœ… F001: æ—¥è¡¨ç¤ºã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
- âœ… F002: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç·¨é›†
- âœ… F005: é›»è©±äºˆç´„æ‰‹å…¥åŠ›
- âœ… F006: äºˆç´„è¡¨å°åˆ·ï¼ˆãƒ‡ãƒ¼ã‚¿åŸºç›¤ï¼‰
- âœ… F007: äºˆç´„æ è¨­å®š
- âœ… F008: è²©å£²åœæ­¢è¨­å®š
- âœ… F101: è¤‡æ•°æ—¥äºˆç´„ä¸€æ‹¬ç™»éŒ²
- âœ… F103: æ¤œç´¢/ãƒ•ã‚£ãƒ«ã‚¿

---

## ğŸ”§ å‰ææ¡ä»¶

### å¿…é ˆç’°å¢ƒ

- PostgreSQL 14ä»¥ä¸Š
- Supabase CLIï¼ˆæ¨å¥¨ï¼‰ã¾ãŸã¯ psql
- Node.js 18.18.0ä»¥ä¸Š
- npm 10.0.0ä»¥ä¸Š

### ç’°å¢ƒå¤‰æ•°

ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒ `.env.local` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼š

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
sql/migrations/
â”œâ”€â”€ README_RESERVATION_SYSTEM.md          # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ reservation_system_schema.sql         # ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”œâ”€â”€ reservation_system_rls.sql            # RLSãƒãƒªã‚·ãƒ¼
â”œâ”€â”€ apply_reservation_system.sql          # å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ rollback_reservation_system.sql       # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

### ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

#### 1. `reservation_system_schema.sql`

**å†…å®¹**: ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ“ãƒ¥ãƒ¼ã€é–¢æ•°ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
**ã‚µã‚¤ã‚º**: ~800è¡Œ
**å®Ÿè¡Œæ™‚é–“**: ç´„5-10ç§’

#### 2. `reservation_system_rls.sql`

**å†…å®¹**: RLSãƒãƒªã‚·ãƒ¼ã€ãƒˆãƒªã‚¬ãƒ¼ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
**ã‚µã‚¤ã‚º**: ~600è¡Œ
**å®Ÿè¡Œæ™‚é–“**: ç´„3-5ç§’

#### 3. `apply_reservation_system.sql`

**å†…å®¹**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ + æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
**ã‚µã‚¤ã‚º**: ~150è¡Œ
**å®Ÿè¡Œæ™‚é–“**: ç´„10-15ç§’

#### 4. `rollback_reservation_system.sql`

**å†…å®¹**: å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…¨å‰Šé™¤ï¼‰
**ã‚µã‚¤ã‚º**: ~180è¡Œ
**å®Ÿè¡Œæ™‚é–“**: ç´„3-5ç§’

---

## ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †

### æ–¹æ³•1: Supabase CLIï¼ˆæ¨å¥¨ï¼‰

```bash
# 1. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³
supabase login

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDç¢ºèª
supabase projects list

# 3. ãƒ­ãƒ¼ã‚«ãƒ«DBèµ·å‹•ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
supabase start

# 4. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
supabase db reset  # æ—¢å­˜DBã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

# 5. ã‚¹ã‚­ãƒ¼ãƒé©ç”¨
cd sql/migrations
psql -h localhost -p 54322 -U postgres -d postgres -f apply_reservation_system.sql

# 6. å‹å®šç¾©å†ç”Ÿæˆ
npm run supabase:types
```

### æ–¹æ³•2: psqlç›´æ¥å®Ÿè¡Œ

```bash
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
psql "postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres"

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
\i sql/migrations/apply_reservation_system.sql

# 3. æˆåŠŸç¢ºèª
\dt public.*
\dv public.*

# 4. å‹å®šç¾©å†ç”Ÿæˆ
npm run supabase:types
```

### æ–¹æ³•3: Supabase Dashboardï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

1. Supabase Dashboard â†’ SQL Editor ã‚’é–‹ã
2. `reservation_system_schema.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ â†’ å®Ÿè¡Œ
3. `reservation_system_rls.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ â†’ å®Ÿè¡Œ
4. ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹å®šç¾©å†ç”Ÿæˆ: `npm run supabase:types`

---

## ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

### 1. Customersï¼ˆé¡§å®¢ï¼‰

**ç›®çš„**: é¡§å®¢ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | é¡§å®¢ID |
| name | VARCHAR(255) | NOT NULL | é¡§å®¢å |
| name_kana | VARCHAR(255) | | ã‚«ã‚¿ã‚«ãƒŠå |
| phone | VARCHAR(20) | NOT NULL | é›»è©±ç•ªå· |
| email | VARCHAR(255) | | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| line_user_id | VARCHAR(255) | UNIQUE | LINEé€£æºID |
| custom_attributes | JSONB | | ã‚«ã‚¹ã‚¿ãƒ å±æ€§ |
| consent_marketing | BOOLEAN | DEFAULT false | ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åŒæ„ |
| consent_reminder | BOOLEAN | DEFAULT false | ãƒªãƒã‚¤ãƒ³ãƒ‰åŒæ„ |
| total_visits | INTEGER | DEFAULT 0 | ç´¯è¨ˆæ¥é™¢å›æ•° |
| last_visit_date | TIMESTAMPTZ | | æœ€çµ‚æ¥é™¢æ—¥ |
| total_revenue | DECIMAL(10,2) | DEFAULT 0 | ç´¯è¨ˆå£²ä¸Š |
| lifetime_value | DECIMAL(10,2) | DEFAULT 0 | LTV |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- phone, email, line_user_idï¼ˆé«˜é€Ÿæ¤œç´¢ï¼‰
- nameï¼ˆGIN, ãƒˆãƒ©ã‚¤ã‚°ãƒ©ãƒ æ¤œç´¢ï¼‰
- created_at, last_visit_dateï¼ˆã‚½ãƒ¼ãƒˆæœ€é©åŒ–ï¼‰

---

### 2. Menusï¼ˆæ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰

**ç›®çš„**: æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID |
| name | VARCHAR(255) | NOT NULL | ãƒ¡ãƒ‹ãƒ¥ãƒ¼å |
| description | TEXT | | èª¬æ˜ |
| category | VARCHAR(100) | | ã‚«ãƒ†ã‚´ãƒªï¼ˆæ•´ä½“/é¼ç¸ç­‰ï¼‰ |
| price | DECIMAL(10,2) | NOT NULL | æ–™é‡‘ |
| duration_minutes | INTEGER | NOT NULL | æ‰€è¦æ™‚é–“ |
| insurance_type | VARCHAR(50) | | ä¿é™ºåŒºåˆ† |
| buffer_before_minutes | INTEGER | DEFAULT 0 | å‰æº–å‚™æ™‚é–“ |
| buffer_after_minutes | INTEGER | DEFAULT 0 | å¾Œç‰‡ä»˜ã‘æ™‚é–“ |
| is_active | BOOLEAN | DEFAULT true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| is_public | BOOLEAN | DEFAULT true | Webå…¬é–‹ãƒ•ãƒ©ã‚° |

---

### 3. Resourcesï¼ˆãƒªã‚½ãƒ¼ã‚¹ï¼‰

**ç›®çš„**: ã‚¹ã‚¿ãƒƒãƒ•ãƒ»æ–½è¡“å®¤ãƒ»è¨­å‚™ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | ãƒªã‚½ãƒ¼ã‚¹ID |
| name | VARCHAR(255) | NOT NULL | ãƒªã‚½ãƒ¼ã‚¹å |
| type | VARCHAR(50) | NOT NULL | ç¨®åˆ¥ï¼ˆstaff/room/bed/deviceï¼‰ |
| staff_code | VARCHAR(50) | UNIQUE | å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ |
| working_hours | JSONB | NOT NULL | æ›œæ—¥åˆ¥å–¶æ¥­æ™‚é–“ |
| max_concurrent | INTEGER | DEFAULT 1 | åŒæ™‚å¯¾å¿œæ•° |
| supported_menus | UUID[] | | å¯¾å¿œå¯èƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼é…åˆ— |
| is_active | BOOLEAN | DEFAULT true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| is_bookable | BOOLEAN | DEFAULT true | äºˆç´„å—ä»˜å¯èƒ½ãƒ•ãƒ©ã‚° |

**working_hourså½¢å¼**:
```json
{
  "monday": {"start": "09:00", "end": "18:00"},
  "tuesday": {"start": "09:00", "end": "18:00"},
  ...
  "sunday": null
}
```

---

### 4. Reservationsï¼ˆäºˆç´„ï¼‰

**ç›®çš„**: äºˆç´„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | äºˆç´„ID |
| customer_id | UUID | FK â†’ customers | é¡§å®¢ID |
| menu_id | UUID | FK â†’ menus | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID |
| staff_id | UUID | FK â†’ resources | ã‚¹ã‚¿ãƒƒãƒ•ID |
| start_time | TIMESTAMPTZ | NOT NULL | é–‹å§‹æ™‚åˆ» |
| end_time | TIMESTAMPTZ | NOT NULL | çµ‚äº†æ™‚åˆ» |
| status | VARCHAR(50) | NOT NULL | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ8ç¨®é¡ï¼‰ |
| channel | VARCHAR(50) | NOT NULL | äºˆç´„ãƒãƒ£ãƒãƒ« |
| notes | TEXT | | å‚™è€ƒ |
| price | DECIMAL(10,2) | | äºˆç´„æ™‚æ–™é‡‘ |
| actual_price | DECIMAL(10,2) | | å®Ÿéš›è«‹æ±‚é¡ |
| payment_status | VARCHAR(50) | DEFAULT 'unpaid' | æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| reservation_group_id | UUID | | è¤‡æ•°æ—¥äºˆç´„ã‚°ãƒ«ãƒ¼ãƒ—ID |

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¨®åˆ¥**:
- `tentative`: ä»®äºˆç´„
- `confirmed`: ç¢ºå®š
- `arrived`: æ¥é™¢
- `completed`: å®Œäº†
- `cancelled`: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- `no_show`: ç„¡æ–­æ¬ å¸­
- `unconfirmed`: æœªç¢ºèª
- `trial`: ä½“é¨“

**ãƒãƒ£ãƒãƒ«ç¨®åˆ¥**:
- `line`: LINEäºˆç´„
- `web`: Webäºˆç´„
- `phone`: é›»è©±äºˆç´„
- `walk_in`: æ¥é™¢äºˆç´„

**é‡è¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_reservations_staff_time`: è¡çªæ¤œå‡ºç”¨ï¼ˆstaff_id, start_time, end_timeï¼‰
- `idx_reservations_date_range`: æ—¥ä»˜ç¯„å›²æ¤œç´¢ç”¨

---

### 5. Blocksï¼ˆè²©å£²åœæ­¢ï¼‰

**ç›®çš„**: äºˆç´„ãƒ–ãƒ­ãƒƒã‚¯æœŸé–“ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | ãƒ–ãƒ­ãƒƒã‚¯ID |
| resource_id | UUID | FK â†’ resources | ãƒªã‚½ãƒ¼ã‚¹ID |
| start_time | TIMESTAMPTZ | NOT NULL | é–‹å§‹æ™‚åˆ» |
| end_time | TIMESTAMPTZ | NOT NULL | çµ‚äº†æ™‚åˆ» |
| recurrence_rule | TEXT | | ç¹°ã‚Šè¿”ã—ãƒ«ãƒ¼ãƒ«ï¼ˆRRULEï¼‰ |
| reason | VARCHAR(255) | | ãƒ–ãƒ­ãƒƒã‚¯ç†ç”± |
| block_type | VARCHAR(50) | DEFAULT 'manual' | ãƒ–ãƒ­ãƒƒã‚¯ç¨®åˆ¥ |

**block_typeç¨®åˆ¥**:
- `manual`: æ‰‹å‹•è¨­å®š
- `holiday`: ç¥æ—¥
- `vacation`: ä¼‘æš‡
- `training`: ç ”ä¿®
- `maintenance`: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- `emergency`: ç·Šæ€¥

---

### 6. Reservation Historyï¼ˆäºˆç´„å¤‰æ›´å±¥æ­´ï¼‰

**ç›®çš„**: ç›£æŸ»ãƒ­ã‚°ãƒ»å¤‰æ›´å±¥æ­´

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---|------|------|
| id | UUID | PK | å±¥æ­´ID |
| reservation_id | UUID | FK â†’ reservations | äºˆç´„ID |
| action | VARCHAR(50) | NOT NULL | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ |
| old_value | JSONB | | å¤‰æ›´å‰ãƒ‡ãƒ¼ã‚¿ |
| new_value | JSONB | | å¤‰æ›´å¾Œãƒ‡ãƒ¼ã‚¿ |
| change_reason | TEXT | | å¤‰æ›´ç†ç”± |
| created_by | UUID | FK â†’ auth.users | å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| ip_address | INET | | IPã‚¢ãƒ‰ãƒ¬ã‚¹ |

---

## ğŸ”’ RLSãƒãƒªã‚·ãƒ¼

### ãƒ­ãƒ¼ãƒ«å®šç¾©

| ãƒ­ãƒ¼ãƒ« | èª¬æ˜ | æ¨©é™ãƒ¬ãƒ™ãƒ« |
|-------|------|----------|
| `admin` | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… | å…¨æ“ä½œå¯èƒ½ |
| `manager` | åº—èˆ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | é¡§å®¢ãƒ»äºˆç´„ç®¡ç†å¯èƒ½ |
| `staff` | ã‚¹ã‚¿ãƒƒãƒ• | äºˆç´„é–²è¦§ãƒ»æ›´æ–°å¯èƒ½ |
| `customer` | é¡§å®¢ï¼ˆLINEé€£æºæ™‚ï¼‰ | è‡ªåˆ†ã®äºˆç´„ã®ã¿æ“ä½œå¯èƒ½ |
| `anon` | æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ | å…¬é–‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ã®ã¿ |

### ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

#### Customersãƒ†ãƒ¼ãƒ–ãƒ«

| æ“ä½œ | admin | manager | staff | customer | anon |
|-----|-------|---------|-------|----------|------|
| SELECT | âœ… å…¨ä»¶ | âœ… å…¨ä»¶ | âœ… å…¨ä»¶ | âœ… è‡ªåˆ†ã®ã¿ | âŒ |
| INSERT | âœ… | âœ… | âœ… | âŒ | âŒ |
| UPDATE | âœ… | âœ… | âœ… | âŒ | âŒ |
| DELETE | âœ… | âŒ | âŒ | âŒ | âŒ |

#### Reservationsãƒ†ãƒ¼ãƒ–ãƒ«

| æ“ä½œ | admin | manager | staff | customer | anon |
|-----|-------|---------|-------|----------|------|
| SELECT | âœ… å…¨ä»¶ | âœ… å…¨ä»¶ | âœ… å…¨ä»¶ | âœ… è‡ªåˆ†ã®ã¿ | âŒ |
| INSERT | âœ… | âœ… | âœ… | âœ… Web/LINE | âŒ |
| UPDATE | âœ… | âœ… | âœ… | âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã¿ | âŒ |
| DELETE | âœ… | âœ… | âŒ | âŒ | âŒ |

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€

**åŸå› **: éå»ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ®‹å­˜

**è§£æ±ºç­–**:
```sql
-- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
\i sql/migrations/rollback_reservation_system.sql

-- å†åº¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
\i sql/migrations/apply_reservation_system.sql
```

---

### ã‚¨ãƒ©ãƒ¼2: ã€Œæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€

**åŸå› **: å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ¨©é™ä¸è¶³

**è§£æ±ºç­–**:
```sql
-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ¥ç¶š
psql -U postgres ...

-- ã¾ãŸã¯æ¨©é™ä»˜ä¸
GRANT ALL PRIVILEGES ON SCHEMA public TO your_user;
```

---

### ã‚¨ãƒ©ãƒ¼3: ã€Œé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€

**åŸå› **: ã‚¹ã‚­ãƒ¼ãƒä½œæˆå‰ã«RLSã‚’å®Ÿè¡Œ

**è§£æ±ºç­–**:
```bash
# æ­£ã—ã„å®Ÿè¡Œé †åº
1. reservation_system_schema.sql
2. reservation_system_rls.sql

# apply_reservation_system.sqlã‚’ä½¿ç”¨ã™ã‚Œã°é †åºä¿è¨¼
```

---

### ã‚¨ãƒ©ãƒ¼4: ã€Œå‹å®šç¾©ãŒæ›´æ–°ã•ã‚Œãªã„ã€

**åŸå› **: Supabaseå‹å®šç¾©ãŒå¤ã„

**è§£æ±ºç­–**:
```bash
# å‹å®šç¾©å†ç”Ÿæˆ
npm run supabase:types

# Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†èµ·å‹•ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
supabase stop
supabase start
```

---

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```bash
# è­¦å‘Š: å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
psql ... -f sql/migrations/rollback_reservation_system.sql
```

### éƒ¨åˆ†ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ‰‹å‹•ï¼‰

```sql
-- RLSãƒãƒªã‚·ãƒ¼ã®ã¿å‰Šé™¤
DROP POLICY ... ON public.reservations;

-- ç‰¹å®šãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿å‰Šé™¤
DROP TABLE public.reservations CASCADE;

-- ãƒ“ãƒ¥ãƒ¼ã®ã¿å‰Šé™¤
DROP VIEW public.reservation_list_view;
```

---

## âœ… å‹•ä½œç¢ºèª

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_name IN ('customers', 'menus', 'resources', 'reservations', 'blocks', 'reservation_history');
```

æœŸå¾…çµæœ: 6è¡Œ

---

### 2. RLSæœ‰åŠ¹åŒ–ç¢ºèª

```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
    AND tablename IN ('customers', 'menus', 'resources', 'reservations', 'blocks', 'reservation_history');
```

æœŸå¾…çµæœ: å…¨è¡Œã§ `rowsecurity = true`

---

### 3. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç¢ºèª

```sql
SELECT
    (SELECT COUNT(*) FROM public.customers) AS customer_count,
    (SELECT COUNT(*) FROM public.menus) AS menu_count,
    (SELECT COUNT(*) FROM public.resources) AS resource_count;
```

æœŸå¾…çµæœ:
- customer_count: 3
- menu_count: 4
- resource_count: 6ï¼ˆã‚¹ã‚¿ãƒƒãƒ•3 + æ–½è¡“å®¤3ï¼‰

---

### 4. é–¢æ•°å‹•ä½œç¢ºèª

```sql
-- è¡çªãƒã‚§ãƒƒã‚¯é–¢æ•°ãƒ†ã‚¹ãƒˆ
SELECT * FROM check_reservation_conflict(
    'staff1'::UUID,
    NOW()::TIMESTAMPTZ,
    (NOW() + INTERVAL '1 hour')::TIMESTAMPTZ
);
```

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆ

1. Supabaseãƒ­ã‚°ç¢ºèª
   ```bash
   supabase logs
   ```

2. PostgreSQLãƒ­ã‚°ç¢ºèª
   ```bash
   tail -f /var/log/postgresql/postgresql.log
   ```

3. é–‹ç™ºãƒãƒ¼ãƒ ã¸å•ã„åˆã‚ã›

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-11-04 | 1.0 | åˆç‰ˆä½œæˆ |

---

**ğŸ¥ æ•´éª¨é™¢ç®¡ç†SaaS - äºˆç´„ã‚·ã‚¹ãƒ†ãƒ **
