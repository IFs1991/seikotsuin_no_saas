from pathlib import Path

md = """# Jest テスト修正プラン（Windows / jest-windows.json ベース）

## 現状サマリ
- Total: **63 suites / 779 tests**
- Failed: **16 suites / 141 tests**（Passed 636、Pending 2）
- openHandles: **[]**（ハンドルリーク起点の不安定さは薄い）

---

## 失敗の主因（“落ち方”で分類）

### A. `redirect()` 起点で予約系が大量落ち
- `reservation-list`：`REDIRECT:/reservations?view=list`
- `reservation-register`：`REDIRECT:/reservations?view=register`

**背景**
Next.js App Router の `redirect()` は、レンダリングを中断するために **`NEXT_REDIRECT` 相当の例外を投げる**仕様。テストでルート層をそのまま render すると落ちる。

---

### B. Context Provider 未同梱で落ちる
- `reservation-timeline`：`useUserProfileContext must be used within a UserProfileProvider`

---

### C. export/import 崩れ（`is not a function`）
- `auth-flow`：`getRequestInfoFromHeaders is not a function`
- `supabase-guards`：`canAccessClinicScope is not a function`

---

### D. テストコードのスコープミス
- `admin-settings`：`ReferenceError: container is not defined`

---

### E. 非同期待ち / fixture 不整合（Blocks）
- DOM 上に **`Invalid Date`** が見える（fixture の日付が parse できていない/表示ロジックが崩れている可能性）

---

### F. ApiClient：fetch モックが刺さっていない
- `api-client`：`toHaveBeenCalledWith/Times` 期待に対して **Number of calls: 0** 系

---

## 修正のおすすめ順（最短で緑に戻す）

### Phase 1（失敗の塊を一気に削る）
1. **予約系：ルート層（redirect）と UI 層を分離**
2. **Provider 同梱の custom render 導入（test-utils）**
3. **export 一本化 + `requireActual` ベース mock で `is not a function` 根絶**

### Phase 2（安定化・再発防止）
4. **ApiClient：fetch を DI（注入）できる形に**
5. **blocks：Invalid Date を潰し、`await findBy / waitFor` に寄せる**
6. **admin-settings：container 参照を修正（可能なら `screen` 中心へ）**

---

## 具体パッチ案

## 1) 予約系：ルート層と UI 層を分離（推奨）
### 目的
- UI テストが redirect 例外で落ちないようにする
- redirect 自体は「呼ばれたこと」だけ小さく検証

### 実装例
```tsx
// app/reservations/page.tsx（Route layer）
import { redirect } from "next/navigation";
import { ReservationScreen } from "@/components/reservations/ReservationScreen";

export default function ReservationsPage({ searchParams }: { searchParams: { view?: string } }) {
  const view = searchParams?.view ?? "list";
  if (!searchParams?.view) redirect(`/reservations?view=${view}`);
  return <ReservationScreen view={view} />;
}
