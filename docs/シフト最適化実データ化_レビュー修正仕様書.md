# シフト最適化実データ化_レビュー修正仕様書（Phase1）

## 目的
- Phase1実装のレビュー指摘を解消し、UI/テスト/データ取得が仕様通り動作する状態に戻す。
- TDD（E2E）に沿って、実データ表示・空状態・エラー時挙動を安定して検証できるようにする。

## 背景/課題（レビュー指摘）
- `/staff` 画面に `ShiftOptimizer` がマウントされておらず、実データUIが表示されない。
- E2Eが「ダミーが出ない」のみで、実データの表示確認ができていない。
- 「データなし」E2Eがシード有りのまま通ってしまう。
- APIテストがルートハンドラを呼ばず、バリデーション/権限/整形の回帰を検知できない。
- 日付/時間帯が UTC とローカル時刻で混在し、JSTでのズレが発生する可能性。
- 人件費表示で NUL 文字が出力される。
- Playwrightの `storageState` を使ったログイン再利用が未導入。

## 対象範囲
- UI: `src/app/staff/page.tsx` / `src/components/staff/shift-optimizer.tsx`
- API: `src/app/api/staff/shifts/route.ts` / `src/app/api/staff/preferences/route.ts` / `src/app/api/staff/demand-forecast/route.ts`
- テスト: `src/__tests__/e2e-playwright/shift-optimizer.spec.ts` / `src/__tests__/api/staff-shifts.test.ts`
- Playwright設定: `playwright.config.ts` / `src/__tests__/e2e-playwright/global-setup.ts`

## 非対象
- シフト作成/編集機能（Phase2）
- 自動最適化ロジックの高度化（Phase2）
- 既存の `/api/staff`（シフト分析）機能の作り替え

---

## 実装方針

### 1. UI統合
- `/staff` 画面に「シフト最適化」タブを追加し、`ShiftOptimizer` を表示する。
- `clinicId` は `useUserProfileContext` から取得し、`ShiftOptimizer` に渡す。
- 既存の「シフト分析」タブは維持する（`/api/staff` の分析結果を継続利用）。
- `ShiftOptimizer` のローディングに `role="status"` もしくは `data-testid` を付与し、E2Eの安定化を図る。

### 2. 日付/時間帯のタイムゾーン統一
- 仕様として「Asia/Tokyo」を基準とする。
- UI/ API で `YYYY-MM-DD` キー生成と時間帯集計は同一ロジックに揃える。
  - UI: `ShiftOptimizer` の日付比較・カレンダーセル・選択日フィルタ。
  - API: `demand-forecast` の日付・時間帯集計。
- 実装は `Intl.DateTimeFormat` の `timeZone: 'Asia/Tokyo'` を使い、外部依存を増やさない。

### 3. 表示の軽微修正
- 人件費の空値は `'\0'` ではなく空文字 or `—` に置き換える。

---

## テスト戦略（TDD / E2E）

### E2E（Playwright）
- `docs/Playwright_E2E手引書.md` に沿って `storageState` を導入する。
  - `global-setup` で admin ログインし `storage/admin.json` を生成。
  - `playwright.config.ts` の `use.storageState` に指定（必要に応じて project 単位）。
- `shift-optimizer.spec.ts` は `fixtures.ts` の固定ID/メールを使用する。
- `useUserProfile` と `/api/staff` 依存を切り離すため、E2Eでは `/api/auth/profile` と `/api/staff` をスタブする。
- 「データなし」シナリオは `page.route` でAPIレスポンスを空にする（DB削除はしない）。
- 実データ/需要予測のUI検証は、`page.route` で固定レスポンスを返し、APIの整合性は APIテストで担保する。

#### シナリオ（更新）
1. **実データ表示**
   - `/staff` → 「シフト最適化」タブを開く。
   - `E2E Staff 1` / `E2E Staff 2` が表示される（APIレスポンスをスタブ）。
   - ダミー名（山田太郎等）が表示されない。
2. **空状態**
   - `/api/staff/shifts` `/api/staff/preferences` `/api/staff/demand-forecast` を空レスポンス化。
   - 「シフトデータがありません」「需要予測データがありません」「スタッフ希望データがありません」を確認。
3. **需要予測**
   - スタブ済み `forecast` が表示される（件数/時間帯）。
4. **APIエラー**
   - `/api/staff/**` を `route.abort()` し、エラー表示を確認。

### APIテスト（Jest）
- ルートハンドラを実行して検証する（例: `GET(request)`）。
- `ensureClinicAccess` をモックし、`supabase` の `select/eq/gte/lte` の戻り値を制御する。
- 検証項目:
  - `clinic_id` 欠落時の 400
  - 取得成功時の `success` と `data` 形式
  - `demand-forecast` の集計結果（予約→時間帯/日付）
  - 401/403/500 のエラー応答

### TDD作業順
1. E2Eテスト更新（失敗を確認）
2. UI統合とタイムゾーン統一
3. APIテストの本体化
4. E2E/Unitテストの再実行で完了

---

## 実装タスク

### UI
- `src/app/staff/page.tsx`
  - 「シフト最適化」タブ追加
  - `useUserProfileContext()` を追加し `clinicId` を取得
  - `<ShiftOptimizer clinicId={clinicId} />` をマウント
- `src/components/staff/shift-optimizer.tsx`
  - JST日付キー生成のユーティリティ追加
  - ローディングに `role="status"` or `data-testid`
  - 人件費空表示の修正

### API
- `src/app/api/staff/demand-forecast/route.ts`
  - JST基準で `date`/`hour` を集計

### E2E
- `playwright.config.ts`
  - `storageState` の設定
- `src/__tests__/e2e-playwright/global-setup.ts`
  - `storage/admin.json` 生成（必要時）
- `src/__tests__/e2e-playwright/shift-optimizer.spec.ts`
  - 実データ表示の明示アサーション
  - 空状態/エラーの再現を `page.route` で実装
  - `/api/auth/profile` と `shift-optimizer` 用APIのスタブ追加

### Unit/APIテスト
- `src/__tests__/api/staff-shifts.test.ts`
  - ルートハンドラ実行型に書き換え
  - `ensureClinicAccess` モックに変更

---

## 受け入れ基準
- `/staff` の「シフト最適化」タブで実データが表示される。
- E2Eが「実データ表示/空状態/需要予測/エラー」を安定して検証できる。
- APIテストがルートハンドラを実行し、バリデーション/権限制御の回帰を検出できる。
- 日付/時間帯のズレが発生しない（JST前提）。

---

## 変更対象ファイル（予定）
- `src/app/staff/page.tsx`
- `src/components/staff/shift-optimizer.tsx`
- `src/app/api/staff/demand-forecast/route.ts`
- `playwright.config.ts`
- `src/__tests__/e2e-playwright/shift-optimizer.spec.ts`
- `src/__tests__/api/staff-shifts.test.ts`
- `src/__tests__/e2e-playwright/global-setup.ts`（必要時）

---

## 関連ドキュメント
- `docs/シフト最適化実データ化_MVP仕様書.md`
- `docs/Playwright_E2E手引書.md`
- `docs/E2E共通フィクスチャ仕様書.md`

---

## 更新履歴
| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2025-12-31 | Phase1レビュー指摘の修正方針を確定 | Codex |
