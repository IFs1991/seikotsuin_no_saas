# 解決事項

## バックエンド
- APIルートで認証が行われずサービスロールキーで直接データにアクセスしている。任意のリクエストで全店舗データの読み書きが可能。
  - 例: `src/app/api/revenue/route.ts:1`, `src/app/api/staff/route.ts:1`, `src/app/api/daily-reports/route.ts:1`, `src/app/api/chat/route.ts:1`, `src/app/api/ai-comments/route.ts:1`, `src/app/api/dashboard/route.ts:1`
- `createApiError` の引数順が誤っており、コード値が崩れるうえ未定義変数 `searchParams` を参照してランタイム例外が発生する。
  - `src/app/api/patients/route.ts:42-72`
- スタッフ登録APIが固定文字列 `'temporary_hash'` をパスワードとして保存しており、認証基盤が未実装のまま露出している。
  - `src/app/api/staff/route.ts:179-194`
- AIチャット処理が `generateAIResponse` でモック応答のみを返し、実データ連携や Gemini 呼び出しが未実装。
  - `src/app/api/chat/route.ts:88-158`, `src/api/gemini/ai-analysis-service.ts:35-115`

## フロントエンド
- ダッシュボード取得フックがAPI失敗時に静的サンプルへフェールオープンし、問題の検知が困難。
  - `src/hooks/useDashboard.ts:43-115`
- 患者分析フックも初期状態が固定値で、API結果が欠落しても UI が正常値に見える。
  - `src/hooks/usePatientAnalysis.ts:28-133`
- 日報入力画面が `NEXT_PUBLIC_DEFAULT_CLINIC_ID` 固定で送信し、スタッフID も空のままPOSTしている。ログイン利用者に紐付かずデータ整合性が取れない。
  - `src/app/daily-reports/input/page.tsx:69-127`

## セキュリティ
- ミドルウェアの保護対象に `/api` が含まれておらず、上記の認証欠落APIへ匿名アクセスできる。
  - `middleware.ts:46-58`
- レスポンスヘッダーに `X-User-ID` など機微情報を付与しており、ブラウザ拡張や中間者に漏れるリスクがある。必要最小限にする。
  - `middleware.ts:160-175`
- サービスロールキーを使ったクライアントがサーバールートに直置きされているため、コード上でのキー漏洩対策（環境変数管理、権限分離）が未整備。
  - `src/api/database/supabase-client.ts:3-44`, `src/app/api/*/route.ts` 系
