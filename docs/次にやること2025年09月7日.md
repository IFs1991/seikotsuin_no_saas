# 次にやること（2025年09月7日）

本ドキュメントは、セキュリティ/セッション領域のテスト安定化後に実施すべき次アクションを簡潔に整理したものです。ステージングのSupabase(Postgres)構築を中心に、型同期・RLS・CI運用の整備までを段階的に進めます。

## 優先タスク（今日〜翌日）

- Supabaseステージング作成: プロジェクト作成、ロケーション/プラン選定
- 環境変数投入: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- スキーマ適用（最低限）
  - `user_sessions`, `security_events`, `registered_devices`, `session_policies`（既存実装が参照）
  - 必要インデックス（`user_sessions(user_id, clinic_id, is_active, is_revoked)`、`security_events(clinic_id, created_at)` など）
- RLS有効化と基本ポリシー
  - クライアントは本人/所属クリニックのみアクセス可、挿入系はサーバ（サービスロール）に限定
- 型同期（TS生成）
  - `supabase gen types --project-id <id> --schema public > src/types/supabase.ts`
- 疎通確認
  - サーバ側で `user_sessions` insert/select、`security_events` insert が成功すること

## 次点タスク（48〜72時間）

- CI運用の統一
  - パッケージマネージャはnpmに統一、`npm ci`を採用
  - README更新済み、親の `yarn.lock` は削除（重複ロック警告の解消）
- CSPの段階導入
  - `CSP_ROLLOUT_PHASE=report-only` で本番前にレポート収集→ポリシー調整
- UIビルド依存の解消
  - `@heroicons/react` の導入
  - `@/components/ui/*` の参照整理（存在しない場合は代替UIに差し替え）
- 監査/運用
  - サービスロールキーの保護（サーバ専用、クライアントへ露出禁止）
  - ログ/警告の観測基盤（セキュリティ統計レポートの定期確認）

## 確認済み/現状の状態

- テスト安定化
  - security/advanced-security: 実装に整合しグリーン
  - session-management: 統合/性能テストを実装APIに整合済み。必要箇所はピンポイントモックで安定
- モック基盤
  - JestでSupabaseチェーンAPI/thenable対応、`@supabase/ssr`側にインメモリDB導入
  - 実装コードにテスト専用ヒューリスティックは残していない（本番コードは純度維持）

## 実行コマンド例

- 型生成
  - `supabase gen types --project-id <PROJECT_ID> --schema public > src/types/supabase.ts`
- 依存・テスト（npm統一）
  - `rm -rf node_modules && npm ci`
  - `npm test`

## スキーマ（最小骨子の目安）

- user_sessions
  - cols: id(uuid), user_id, clinic_id, session_token, device_info(jsonb), ip_address, user_agent, geolocation(jsonb), created_at, last_activity, expires_at, idle_timeout_at, absolute_timeout_at, is_active, is_revoked, revoked_at, revoked_by, revoked_reason, max_idle_minutes, max_session_hours, remember_device
- security_events
  - cols: id, user_id, clinic_id, session_id, event_type, event_category, severity_level, event_description, event_data(jsonb), ip_address, user_agent, source_component, created_at
- registered_devices
  - cols: id, user_id, clinic_id, device_fingerprint, is_trusted, trust_score, trust_level, trusted_at, blocked_at, blocked_reason
- session_policies
  - cols: id, clinic_id, role, is_active, max_concurrent_sessions, max_idle_minutes, max_session_hours, block_concurrent_different_ips, max_devices_per_user, remember_device_days, require_device_registration, notify_new_device_login

## リスクと備考

- UIビルドは依存不足で現時点NG（テスト実行には影響なし）。別途対応
- 一部テストのエラーログは設計上のフォールバック（例外は投げず継続）。必要に応じてテスト内でログサプレッション
- RLS/監査の最終確認は実DB上で実施（本番想定の権限で動作確認）

---

上記に沿って、まずはSupabaseステージングの作成→スキーマ適用→RLS→型生成→疎通確認までを完了させ、その後UI依存とCSPの本番導入計画に移行してください。
