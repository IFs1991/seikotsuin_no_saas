# 整骨院管理SaaS セキュリティ引き継ぎ仕様書

**作成日**: 2026-01-01
**最終更新**: 2026-01-01
**対象システム**: 整骨院管理SaaS
**セキュリティレベル**: エンタープライズグレード（医療機関向け）
**作成者**: 元セキュリティ部門シニアエンジニア / PM

---

## 目次

1. [エグゼクティブサマリー](#1-エグゼクティブサマリー)
2. [セキュリティアーキテクチャ](#2-セキュリティアーキテクチャ)
3. [認証システム](#3-認証システム)
4. [認可とアクセス制御](#4-認可とアクセス制御)
5. [多層防御設計](#5-多層防御設計)
6. [入力検証とサニタイゼーション](#6-入力検証とサニタイゼーション)
7. [セッション管理](#7-セッション管理)
8. [多要素認証（MFA）](#8-多要素認証mfa)
9. [レート制限](#9-レート制限)
10. [Content Security Policy（CSP）](#10-content-security-policycsp)
11. [監査ログシステム](#11-監査ログシステム)
12. [データベースセキュリティ（RLS）](#12-データベースセキュリティrls)
13. [セキュリティ監視ダッシュボード](#13-セキュリティ監視ダッシュボード)
14. [設定値一覧](#14-設定値一覧)
15. [既知のリスクと対策](#15-既知のリスクと対策)
16. [運用ガイドライン](#16-運用ガイドライン)
17. [インシデント対応手順](#17-インシデント対応手順)
18. [付録：ファイルマッピング](#付録ファイルマッピング)

---

## 1. エグゼクティブサマリー

### 1.1 システム概要

本システムは整骨院向けのマルチテナントSaaSであり、患者情報・予約管理・売上分析等の機密性の高い医療関連データを取り扱う。

### 1.2 セキュリティ成熟度

| 領域 | 成熟度 | 評価 |
|------|--------|------|
| 認証 | ★★★★★ | Supabase Auth + MFA対応 |
| 認可 | ★★★★★ | RBAC + RLS二重防御 |
| 入力検証 | ★★★★★ | Zod + Allowlistサニタイザー |
| セッション管理 | ★★★★★ | 多デバイス制御 + 自動タイムアウト |
| レート制限 | ★★★★☆ | 段階的ブロック実装済み |
| CSP | ★★★★★ | 段階的ロールアウト + Nonce |
| 監査ログ | ★★★★★ | 全操作追跡 + DB障害時フォールバック |
| 監視 | ★★★★☆ | ダッシュボード + 自動アラート |

### 1.3 準拠規格・要件

- OWASP Top 10 2021対応
- 医療機関向けセキュリティ要件準拠
- 個人情報保護法対応

---

## 2. セキュリティアーキテクチャ

### 2.1 多層防御モデル

```
┌─────────────────────────────────────────────────────────────────┐
│ Layer 1: Edge Protection                                        │
│   - HTTPS強制（Vercel Edge）                                    │
│   - CSP/セキュリティヘッダー                                     │
│   - レート制限（Redis-backed）                                  │
├─────────────────────────────────────────────────────────────────┤
│ Layer 2: Middleware Protection                                  │
│   - 認証チェック（Supabase JWT検証）                            │
│   - ルートベースアクセス制御                                     │
│   - Nonce生成・CSP適用                                          │
│   - キャッシュ制御                                               │
├─────────────────────────────────────────────────────────────────┤
│ Layer 3: Application Protection                                 │
│   - Zodスキーマバリデーション                                   │
│   - DOMPurifyサニタイゼーション                                 │
│   - Allowlist方式PostgRESTサニタイザー                          │
│   - CSRF対策（Origin検証）                                      │
│   - processApiRequest()による統一認可                           │
├─────────────────────────────────────────────────────────────────┤
│ Layer 4: Data Protection                                        │
│   - Supabase RLS（Row Level Security）                          │
│   - テナント分離（clinic_id）                                   │
│   - 論理削除（is_deleted）                                      │
│   - 監査ログ自動記録                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 トラストバウンダリー

```
┌──────────────────────────────────────────────────────────────────┐
│ 外部（Untrusted）                                                │
│   - ブラウザクライアント                                         │
│   - 外部API                                                      │
└──────────────────────────────────────────────────────────────────┘
                              ↓ HTTPS + JWT
┌──────────────────────────────────────────────────────────────────┐
│ DMZ (Semi-Trusted)                                               │
│   - Next.js Middleware                                           │
│   - Edge Functions                                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓ 認証済みリクエスト
┌──────────────────────────────────────────────────────────────────┐
│ 内部（Trusted）                                                  │
│   - API Routes                                                   │
│   - Server Components                                            │
│   - Supabase（RLS適用済み）                                      │
└──────────────────────────────────────────────────────────────────┘
```

---

## 3. 認証システム

### 3.1 認証フロー

| ルート | 認証プロバイダー | 用途 |
|--------|------------------|------|
| `/login` | Supabase Auth | クリニックスタッフ用 |
| `/admin/login` | Supabase Auth | HQ管理者用 |
| `/invite` | Magic Link | スタッフ招待 |

### 3.2 JWT構造

```typescript
interface JWTClaims {
  sub: string;           // user_id
  email: string;
  role: UserRole;        // admin | clinic_manager | manager | staff | customer
  clinic_id: string;     // テナント識別子
  iat: number;           // 発行日時
  exp: number;           // 有効期限
}
```

### 3.3 認証ガード実装

**ファイル**: `src/lib/supabase/guards.ts`

```typescript
// クリニックアクセス検証
async function ensureClinicAccess(
  request: Request,
  path: string,
  clinicId: string | null,
  options?: ClinicAccessOptions
): Promise<ClinicAccessContext>
```

**特徴**:
- 認証失敗時に監査ログ記録
- クロスクリニックアクセス拒否
- 特権ロール（admin, clinic_admin）のみクロスアクセス許可

### 3.4 保護対象ルート

```typescript
const PROTECTED_ROUTE_PREFIXES = [
  '/dashboard',
  '/admin',
  '/staff',
  '/patients',
  '/revenue',
  '/reservations',
  '/daily-reports',
  '/chat',
  '/ai-insights',
  '/master-data',
];

const ADMIN_ONLY_PREFIXES = ['/admin'];
const HQ_ROLES = ['admin', 'clinic_manager', 'manager'];
```

---

## 4. 認可とアクセス制御

### 4.1 ロール階層

```
admin
  └── clinic_manager
        └── manager
              └── staff
                    └── customer
```

### 4.2 ロール別権限マトリックス

| 機能 | admin | clinic_manager | manager | staff | customer |
|------|-------|----------------|---------|-------|----------|
| 全クリニック参照 | ✅ | ❌ | ❌ | ❌ | ❌ |
| ユーザー管理 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 予約管理 | ✅ | ✅ | ✅ | ✅ | 自分のみ |
| 顧客データ参照 | ✅ | ✅ | ✅ | ✅ | 自分のみ |
| 顧客データ削除 | ✅ | ❌ | ❌ | ❌ | ❌ |
| メニュー管理 | ✅ | ✅ | ✅ | ❌ | ❌ |
| セキュリティ設定 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 監査ログ参照 | ✅ | ✅ | ✅ | ❌ | ❌ |

### 4.3 API認可パターン

```typescript
// src/lib/api-helpers.ts
export async function processApiRequest<T>(
  request: Request,
  options: {
    requireAuth?: boolean;
    requireRole?: UserRole[];
    requireClinic?: boolean;
    schema?: ZodSchema<T>;
  }
): Promise<ProcessApiResult<T>>
```

**検証順序**:
1. JWT有効性検証
2. ロール検証（requireRole）
3. クリニックアクセス検証（requireClinic）
4. スキーマバリデーション（schema）
5. 入力サニタイゼーション

---

## 5. 多層防御設計

### 5.1 PostgRESTフィルターインジェクション対策

**問題**: 検索クエリがPostgRESTフィルター文字列に直接挿入

**対策**: Allowlist方式サニタイザー

**ファイル**: `src/lib/postgrest-sanitizer.ts`

```typescript
// 許可文字パターン
const ALLOWED_CHARS_PATTERN = /^[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\uFF00-\uFFEFa-zA-Z0-9\s\-_@.]+$/;

// 危険文字を削除
export function sanitizePostgrestValue(value: string): string {
  return value.replace(DISALLOWED_CHARS_PATTERN, '');
}

// 安全な検索フィルター構築
export function buildSafeSearchFilter(query: string, columns: string[]): string | null;
```

**許可文字**:
- 日本語（ひらがな、カタカナ、漢字）
- 英数字
- ハイフン、スペース、アンダースコア
- @、.（メールアドレス用）

**削除文字**:
- `,`（フィルター区切り）
- `%`（ワイルドカード）
- `()`（関数呼び出し）
- `[]`（配列）

### 5.2 XSS対策

**ファイル**: `src/lib/api-helpers.ts`

```typescript
export function sanitizeInput(obj: unknown): unknown {
  // DOMPurify使用
  // プロトタイプ汚染防止（__proto__, constructor, prototype除去）
}
```

### 5.3 CSRF対策

```typescript
const ALLOWED_REDIRECT_ORIGINS = [
  'https://seikotsuin-saas.com',
  'http://localhost:3000', // 開発環境
];

// Origin検証
function validateOrigin(request: Request): boolean {
  const origin = request.headers.get('origin');
  return ALLOWED_REDIRECT_ORIGINS.includes(origin);
}
```

---

## 6. 入力検証とサニタイゼーション

### 6.1 Zodスキーマバリデーション

**例**: `src/app/api/customers/schema.ts`

```typescript
export const searchQuerySchema = z
  .string()
  .max(100, '検索クエリは100文字以内で入力してください')
  .transform(value => {
    const trimmed = value.trim();
    return trimmed.length === 0 ? undefined : trimmed;
  })
  .optional();
```

### 6.2 バリデーション階層

```
1. Zodスキーマ（型・長さ・形式）
    ↓
2. Allowlistサニタイザー（危険文字除去）
    ↓
3. DOMPurify（XSSペイロード除去）
    ↓
4. RLS（データベースレベル検証）
```

### 6.3 パスワードポリシー

```typescript
const PASSWORD_POLICY = {
  minLength: 8,
  maxLength: 128,
  requireUppercase: true,
  requireLowercase: true,
  requireNumber: true,
  requireSpecialChar: true,
  specialChars: '!@#$%^&*()_+-=[]{}|;:,.<>?',
};
```

---

## 7. セッション管理

### 7.1 セッション設定

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| セッションタイムアウト | 8時間 | 非アクティブ時 |
| リフレッシュトークン有効期限 | 7日 | 自動更新 |
| 最大同時デバイス数 | 3台 | デフォルト |
| 新デバイス信頼期間 | 7日 | 自動信頼判定 |

### 7.2 複数デバイス管理

**ファイル**: `src/lib/multi-device-manager.ts`

```typescript
interface MultiDeviceConfig {
  maxConcurrentDevices: number;      // 最大同時デバイス数
  requireDeviceTrust: boolean;       // デバイス信頼要求
  notifyNewDevice: boolean;          // 新デバイス通知
  autoRevokeOldSessions: boolean;    // 古いセッション自動失効
  trustNewDeviceAfterDays: number;   // 信頼判定日数
}
```

**機能**:
- デバイス信頼判定（指紋 + 使用期間）
- 新デバイス検出（OS/Browser差異）
- 位置変更検出（IP + 地理情報）
- セッション強制終了

### 7.3 セキュリティアラート種類

| タイプ | 説明 | 重要度 |
|--------|------|--------|
| `new_device` | 新デバイスからのアクセス | warning |
| `suspicious_activity` | 疑わしい活動 | error |
| `concurrent_limit` | デバイス数上限超過 | warning |
| `location_change` | 異常な位置からのアクセス | error |

---

## 8. 多要素認証（MFA）

### 8.1 TOTP実装

**ファイル**: `src/lib/mfa/mfa-manager.ts`

```typescript
// speakeasyライブラリ使用（RFC 4648準拠）
const secret = speakeasy.generateSecret({
  length: 32,  // 256ビット強度
  name: 'SeikoTsuin Management',
});
```

### 8.2 バックアップコード

- 生成数: 10個
- 形式: 8桁数字
- 一度使用で無効化
- ハッシュ化して保存

### 8.3 MFA強制ルール

| ロール | MFA強制 |
|--------|---------|
| admin | 強制 |
| clinic_manager | 強制 |
| manager | 推奨 |
| staff | 任意 |
| customer | 任意 |

---

## 9. レート制限

### 9.1 レート制限設定

**ファイル**: `src/lib/rate-limiting/rate-limiter.ts`

| タイプ | ウィンドウ | 制限値 | ブロック期間 |
|--------|-----------|--------|--------------|
| LOGIN_ATTEMPTS | 15分 | 5回 | 段階的 |
| API_CALLS | 1分 | 100回 | - |
| SESSION_CREATION | 5分 | 3回 | 30分 |
| MFA_ATTEMPTS | 5分 | 10回 | 15分 |

### 9.2 段階的ブロック

```typescript
const BLOCK_ESCALATION = [
  60 * 1000,        // Level 0: 1分
  5 * 60 * 1000,    // Level 1: 5分
  60 * 60 * 1000,   // Level 2: 1時間
  24 * 60 * 60 * 1000, // Level 3: 24時間
];
```

### 9.3 パス別レート制限

```typescript
function getPathRateLimit(pathname: string): RateLimitMiddleware[] {
  if (pathname.startsWith('/api/auth/') || pathname.startsWith('/login')) {
    return [loginRateLimit];
  }
  if (pathname.startsWith('/api/session/')) {
    return [sessionCreationRateLimit];
  }
  if (pathname.startsWith('/api/mfa/')) {
    return [mfaRateLimit];
  }
  if (pathname.startsWith('/api/')) {
    return [apiRateLimit];
  }
  return [];
}
```

### 9.4 フェイルオープン設計

```typescript
// Redis障害時はリクエストを許可（可用性優先）
try {
  return await checkRateLimit(key, config);
} catch (error) {
  console.error('Rate limit check failed:', error);
  return { allowed: true }; // Fail open
}
```

---

## 10. Content Security Policy（CSP）

### 10.1 段階的ロールアウト

**ファイル**: `src/lib/security/csp-config.ts`

| フェーズ | ヘッダー | 動作 |
|----------|----------|------|
| `report-only` | CSP-Report-Only | 違反監視のみ |
| `partial-enforce` | CSP + CSP-Report-Only | 一部強制 |
| `full-enforce` | CSP | 完全強制 |

### 10.2 環境別CSP

| 環境 | 特徴 |
|------|------|
| 開発 | `unsafe-inline`, `unsafe-eval`許可 |
| 本番 | Nonce + ハッシュベース |
| 医療グレード | Trusted Types API対応 |

### 10.3 Nonce生成

```typescript
// middleware.ts
const nonce = CSPConfig.generateNonce();
response.headers.set('x-nonce', nonce);
response.headers.set('x-nonce-timestamp', Date.now().toString());
```

### 10.4 違反レポート処理

```typescript
interface CSPViolation {
  documentUri: string;
  violatedDirective: string;
  blockedUri: string;
  sourceFile: string;
  lineNumber: number;
}

function classifyViolationSeverity(violation: CSPViolation): Severity {
  if (violation.violatedDirective === 'script-src' &&
      violation.blockedUri.includes('javascript:')) {
    return 'critical';
  }
  if (violation.violatedDirective === 'script-src') {
    return 'high';
  }
  if (violation.violatedDirective === 'frame-ancestors') {
    return 'medium';
  }
  return 'low';
}
```

---

## 11. 監査ログシステム

### 11.1 イベントタイプ

**ファイル**: `src/lib/audit-logger.ts`

| イベント | 説明 |
|----------|------|
| `LOGIN` | ログイン成功 |
| `LOGOUT` | ログアウト |
| `FAILED_LOGIN` | ログイン失敗 |
| `UNAUTHORIZED_ACCESS` | 権限なしアクセス試行 |
| `DATA_ACCESS` | データ参照 |
| `DATA_MODIFY` | データ変更 |
| `DATA_DELETE` | データ削除 |
| `ADMIN_ACTION` | 管理者操作 |
| `PERMISSION_CHANGE` | 権限変更 |
| `SYSTEM_CONFIG` | システム設定変更 |
| `EXPORT_DATA` | データエクスポート |

### 11.2 ログ構造

```typescript
interface AuditLog {
  id: string;
  timestamp: Date;
  event_type: EventType;
  user_id: string;
  user_email: string;
  clinic_id: string;
  resource_type: string;
  resource_id: string;
  action: string;
  details: Record<string, unknown>;
  ip_address: string;
  user_agent: string;
  success: boolean;
}
```

### 11.3 主要メソッド

```typescript
class AuditLogger {
  static async logLogin(userId, email, clinicId, ip, userAgent): Promise<void>;
  static async logFailedLogin(email, reason, ip, userAgent): Promise<void>;
  static async logUnauthorizedAccess(path, reason, userId, email, ip, userAgent): Promise<void>;
  static async logDataAccess(userId, email, resourceType, resourceId, clinicId, details): Promise<void>;
  static async logDataModify(userId, email, resourceType, resourceId, clinicId, changes): Promise<void>;
  static async logDataDelete(userId, email, resourceType, resourceId, clinicId): Promise<void>;
  static async logAdminAction(userId, email, action, resourceId, details): Promise<void>;
  static async logDataExport(userId, email, exportType, recordCount, clinicId): Promise<void>;
}
```

### 11.4 DB障害時フォールバック

```typescript
try {
  await supabase.from('audit_logs').insert(log);
} catch (error) {
  // 構造化ログとしてコンソール出力
  console.log(JSON.stringify({
    level: 'AUDIT',
    ...log,
    fallback: true,
  }));
}
```

### 11.5 保持期間

```typescript
const AUDIT_LOG = {
  retentionDays: 90,
};
```

---

## 12. データベースセキュリティ（RLS）

### 12.1 RLS有効化テーブル

| テーブル | RLS | 説明 |
|----------|-----|------|
| `clinics` | ✅ | クリニック情報 |
| `profiles` | ✅ | ユーザープロファイル |
| `user_permissions` | ✅ | 権限設定 |
| `customers` | ✅ | 顧客情報 |
| `reservations` | ✅ | 予約情報 |
| `menus` | ✅ | メニュー |
| `resources` | ✅ | リソース |
| `blocks` | ✅ | ブロック時間 |
| `reservation_history` | ✅ | 予約履歴（監査） |
| `security_events` | ✅ | セキュリティイベント |
| `user_mfa_settings` | ✅ | MFA設定 |

### 12.2 RLSポリシー設計パターン

**パターン1: テナント分離**
```sql
CREATE POLICY "tenant_isolation"
ON table_name FOR ALL
USING (
  clinic_id = (SELECT clinic_id FROM profiles WHERE user_id = auth.uid())
);
```

**パターン2: ロールベース**
```sql
CREATE POLICY "role_based_access"
ON table_name FOR SELECT
USING (
  public.user_role() IN ('admin', 'manager', 'staff')
);
```

**パターン3: 自己データ限定**
```sql
CREATE POLICY "self_access"
ON table_name FOR SELECT
USING (
  user_id = auth.uid()
);
```

### 12.3 顧客テーブルRLS例

```sql
-- 管理者・スタッフは全件参照可能
CREATE POLICY "customers_select_for_staff"
ON public.customers FOR SELECT
USING (public.user_role() IN ('admin', 'staff', 'manager'));

-- 管理者のみ削除可能（論理削除）
CREATE POLICY "customers_delete_for_admin"
ON public.customers FOR DELETE
USING (public.user_role() = 'admin');

-- 顧客本人は自分のデータのみ参照可能
CREATE POLICY "customers_select_for_self"
ON public.customers FOR SELECT
USING (
  public.user_role() = 'customer' AND id = auth.uid()
);
```

### 12.4 予約履歴トリガー

```sql
-- 予約作成時の履歴自動記録
CREATE TRIGGER reservation_created_log
  AFTER INSERT ON public.reservations
  FOR EACH ROW EXECUTE FUNCTION log_reservation_created();

-- 予約更新時の履歴自動記録
CREATE TRIGGER reservation_updated_log
  AFTER UPDATE ON public.reservations
  FOR EACH ROW EXECUTE FUNCTION log_reservation_updated();

-- 予約削除時の履歴自動記録
CREATE TRIGGER reservation_deleted_log
  AFTER DELETE ON public.reservations
  FOR EACH ROW EXECUTE FUNCTION log_reservation_deleted();
```

---

## 13. セキュリティ監視ダッシュボード

### 13.1 概要

**ファイル**: `src/components/admin/SecurityDashboard.tsx`

### 13.2 メトリクスカード

| メトリクス | 説明 |
|------------|------|
| 総ユーザー数 | システム全体のユーザー数 |
| MFA有効率 | MFA有効ユーザーの割合 |
| アクティブセッション | 現在有効なセッション数 |
| 脅威検知数 | 検知されたセキュリティイベント |
| ブロック数 | レート制限等でブロックした数 |
| 成功ログイン数 | 直近の成功ログイン |

### 13.3 セキュリティイベント管理

| ステータス | 説明 |
|------------|------|
| `new` | 新規イベント |
| `investigating` | 調査中 |
| `resolved` | 解決済み |
| `false_positive` | 誤検知 |

| 重要度 | 説明 | 色 |
|--------|------|-----|
| `critical` | 緊急対応必要 | 赤 |
| `error` | 重大な問題 | オレンジ |
| `warning` | 注意が必要 | 黄 |
| `info` | 情報 | 青 |

### 13.4 アクティブセッション管理

- ユーザー、デバイス、場所、IP、最終アクティビティ表示
- リスクレベル表示（low/medium/high）
- セッション強制終了機能

### 13.5 レポート機能

```csv
イベントタイプ,重要度,説明,IP,日時,ステータス,解決メモ
```

### 13.6 自動更新

- 30秒ごとに自動リフレッシュ

---

## 14. 設定値一覧

### 14.1 セキュリティ定数

**ファイル**: `src/lib/constants/security.ts`

```typescript
// リダイレクト許可オリジン
export const ALLOWED_REDIRECT_ORIGINS = [
  'https://seikotsuin-saas.com',
  'http://localhost:3000',
];

// セキュアリダイレクト先
export const SECURE_REDIRECT_PATHS = {
  admin: '/admin/settings',
  manager: '/dashboard',
  staff: '/dashboard',
};

// セキュリティヘッダー
export const SECURITY_HEADERS = {
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
};

// パスワードポリシー
export const PASSWORD_POLICY = {
  minLength: 8,
  maxLength: 128,
  requireUppercase: true,
  requireLowercase: true,
  requireNumber: true,
  requireSpecialChar: true,
};

// レート制限
export const RATE_LIMIT = {
  login: { windowMs: 15 * 60 * 1000, max: 5 },
  api: { windowMs: 60 * 1000, max: 100 },
};

// セッション設定
export const SESSION_CONFIG = {
  timeoutMs: 8 * 60 * 60 * 1000,
  refreshTokenExpiryDays: 7,
};

// ファイルアップロード
export const FILE_UPLOAD = {
  maxSizeBytes: 10 * 1024 * 1024,
  allowedTypes: ['jpg', 'png', 'gif', 'pdf', 'txt'],
};

// 監査ログ
export const AUDIT_LOG = {
  retentionDays: 90,
};
```

### 14.2 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase URL | ✅ |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase匿名キー | ✅ |
| `SUPABASE_SERVICE_ROLE_KEY` | サービスロールキー | ✅ |
| `CSP_ROLLOUT_PHASE` | CSPフェーズ | ❌ |
| `REDIS_URL` | Redis URL（レート制限） | ❌ |

---

## 15. 既知のリスクと対策

### 15.1 対策済みリスク

| リスク | 対策 | ステータス |
|--------|------|------------|
| PostgRESTインジェクション | Allowlistサニタイザー | ✅ 完了 |
| XSS | DOMPurify + CSP | ✅ 完了 |
| CSRF | Origin検証 | ✅ 完了 |
| SQLインジェクション | Supabase RLS + パラメータ化 | ✅ 完了 |
| セッションハイジャック | Secure Cookie + HTTPS | ✅ 完了 |
| ブルートフォース | レート制限 + 段階的ブロック | ✅ 完了 |
| テナント間漏洩 | RLS + clinic_id検証 | ✅ 完了 |
| Open Redirect | 許可オリジン検証 | ✅ 完了 |
| プロトタイプ汚染 | キー除去サニタイザー | ✅ 完了 |

### 15.2 運用上の注意点

| 項目 | 説明 | 推奨対応 |
|------|------|----------|
| Redis障害 | レート制限がフェイルオープン | 監視アラート設定 |
| CSP違反多発 | サードパーティスクリプト追加時 | 段階的ロールアウト使用 |
| MFA未設定管理者 | セキュリティリスク | 強制MFA設定 |
| 長期セッション | セッションハイジャックリスク | 8時間タイムアウト遵守 |

### 15.3 将来の改善提案

| 優先度 | 提案 | 説明 |
|--------|------|------|
| 高 | WAF導入 | Cloudflare等のWAF追加 |
| 高 | SIEM統合 | セキュリティログ集約分析 |
| 中 | ペネトレーションテスト | 外部診断の定期実施 |
| 中 | セキュリティ研修 | スタッフ向け教育 |
| 低 | SOC2準拠 | 認証取得 |

---

## 16. 運用ガイドライン

### 16.1 日次タスク

- [ ] セキュリティダッシュボード確認
- [ ] 新規セキュリティイベント確認・対応
- [ ] 異常なログイン試行確認

### 16.2 週次タスク

- [ ] 監査ログレビュー
- [ ] レート制限統計確認
- [ ] アクティブセッション棚卸し

### 16.3 月次タスク

- [ ] パスワード変更勧告（該当者）
- [ ] MFA設定状況確認
- [ ] セキュリティイベントトレンド分析
- [ ] 監査ログエクスポート・バックアップ

### 16.4 四半期タスク

- [ ] 権限棚卸し
- [ ] 不要アカウント削除
- [ ] セキュリティポリシーレビュー
- [ ] 依存パッケージ脆弱性スキャン

---

## 17. インシデント対応手順

### 17.1 重大度分類

| レベル | 説明 | 対応時間 |
|--------|------|----------|
| P1 (Critical) | データ漏洩、システム侵害 | 15分以内 |
| P2 (High) | 認証バイパス、権限昇格 | 1時間以内 |
| P3 (Medium) | レート制限回避、軽微な脆弱性 | 24時間以内 |
| P4 (Low) | 情報漏洩リスク（低） | 1週間以内 |

### 17.2 対応フロー

```
1. 検知
   ↓
2. トリアージ（重大度判定）
   ↓
3. 封じ込め
   - セッション強制終了
   - アカウントロック
   - ネットワーク分離
   ↓
4. 調査
   - 監査ログ分析
   - 影響範囲特定
   ↓
5. 復旧
   - パッチ適用
   - 設定修正
   ↓
6. 報告・改善
   - インシデントレポート作成
   - 再発防止策実施
```

### 17.3 緊急連絡先

| 役割 | 連絡先 | 担当 |
|------|--------|------|
| セキュリティ責任者 | - | 要設定 |
| システム管理者 | - | 要設定 |
| 法務担当 | - | 要設定 |

---

## 付録：ファイルマッピング

### セキュリティ関連ファイル一覧

| カテゴリ | ファイルパス | 説明 |
|----------|--------------|------|
| **認証** | `middleware.ts` | 認証ミドルウェア |
| | `src/lib/supabase/guards.ts` | クリニックアクセスガード |
| | `src/lib/api-helpers.ts` | API認証・サニタイゼーション |
| **MFA** | `src/lib/mfa/mfa-manager.ts` | MFA管理 |
| **セッション** | `src/lib/multi-device-manager.ts` | 複数デバイス管理 |
| **レート制限** | `src/lib/rate-limiting/rate-limiter.ts` | レート制限コア |
| | `src/lib/rate-limiting/middleware.ts` | レート制限ミドルウェア |
| **CSP** | `src/lib/security/csp-config.ts` | CSP設定 |
| **監査** | `src/lib/audit-logger.ts` | 監査ログ |
| **定数** | `src/lib/constants/security.ts` | セキュリティ定数 |
| **サニタイザー** | `src/lib/postgrest-sanitizer.ts` | PostgRESTサニタイザー |
| **UI** | `src/components/admin/SecurityDashboard.tsx` | セキュリティダッシュボード |
| **API** | `src/app/api/admin/security/events/route.ts` | セキュリティイベントAPI |
| | `src/app/api/admin/security/stats/route.ts` | セキュリティ統計API |
| | `src/app/api/admin/security/metrics/route.ts` | メトリクスAPI |
| | `src/app/api/admin/security/sessions/route.ts` | セッションAPI |
| **RLS** | `supabase/migrations/20251104000200_reservation_system_rls.sql` | 予約システムRLS |
| | `supabase/migrations/20251224000500_admin_clinic_permissions_rls.sql` | 管理者権限RLS |
| | `supabase/migrations/20260102000300_mfa_rls_role_alignment.sql` | MFA RLS |
| **テスト** | `src/__tests__/lib/postgrest-sanitizer.test.ts` | サニタイザーテスト |
| | `src/__tests__/api/security-events-authorization.test.ts` | 認可テスト |
| | `src/__tests__/api/customers-schema.test.ts` | スキーマテスト |

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2026-01-01 | 初版作成 | 元セキュリティ部門シニアエンジニア / PM |

---

**End of Document**
