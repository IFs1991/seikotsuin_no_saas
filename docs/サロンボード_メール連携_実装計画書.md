# サロンボード_メール連携_実装計画書

## 目的
- サロンボード通知メールを取り込み、予約タイムラインへ自動反映する
- 既存の予約UI/UXに自然に統合し、手入力を最小化する

## 対象範囲
- メール受信 → Webhook → 予約登録/更新 → タイムライン反映
- 予約データの重複排除、失敗時の再処理、監査ログ

## 全体フロー
1. メール受信（外部メールサービスで受信）
2. Webhookでアプリに配信
3. 受信本文をパースして予約データ抽出
4. 顧客/メニュー/リソースの紐付け
5. 予約テーブルへ upsert
6. 予約タイムラインへ即時反映

## 実装フェーズ
### Phase 1: 受信基盤
- メール受信サービス選定（例: Mailgun / SendGrid / SES）
- 受信用アドレス発行（例: `salonboard@yourdomain`）
- Webhook 受信エンドポイント作成
  - `POST /api/integrations/salonboard/email`
  - 署名検証（必須）
  - 受信ログ保存（audit）

### Phase 2: パーサー
- メールテンプレート解析（件名/本文/予約項目）
- パーサーの正規表現/フォーマット対応
- 失敗時のエラー分類と保存

### Phase 3: 予約変換
- 顧客マッチング（電話/氏名）
- メニュー/リソースの紐付けルール
- 予約日時の正規化（タイムゾーン注意）
- 既存予約の重複排除（外部ID or ハッシュ）

### Phase 4: 反映・通知
- `reservations` へ upsert
- タイムラインに即時反映（API再取得 or realtime）
- 失敗時の再試行キュー

## DB/スキーマ
### 追加テーブル（例）
- `external_inbound_emails`
  - raw payload / parsed payload / status / error
- `external_reservations`
  - external_id / source / reservation_id / dedupe_hash

### 追加カラム
- `reservations.external_source`
- `reservations.external_id`

## エラーハンドリング
- 解析不能メール → 保留ボックス（再処理可能）
- 重複予約 → 無視 or 更新
- 予約対象が見つからない場合 → 暫定リソースへ振り分け

## セキュリティ
- Webhook 署名検証
- IP制限（可能なら）
- 受信メールのサイズ制限
- PIIマスキングログ

## テスト項目
- 正常メールの予約反映
- 予約キャンセル通知の反映
- 重複メールの再送
- 文字化け/不正フォーマット

## 運用
- 連携状態の可視化（管理画面）
- 失敗ログの一覧と再試行
- サロンボード側のテンプレート変更検知

## 次の作業
- 使用メールサービスの決定
- サンプルメールの確保
- フィールドマッピング定義
