# 初回ユーザー登録 実装タスクリスト v0.2

作成日: 2026-02-18
更新日: 2026-02-19（コードベース・マイグレーション全体レビューによる追記）
親仕様: `docs/初回ユーザー登録_UIUX機能一体仕様書_v0.2.md`
実行ルール: 1タスク = 1PR（小さく独立）

---

## 0. 前提

- DBマイグレーションは行わない（Out of Scope）。
- リポジトリ上の `staff_invites` ロール不整合は既存マイグレーションで修正済み。ただし **ローカルDBの適用漏れ（ドリフト）** があり得るため、PR-00b で事前検証する。
- 既存 `/invite` フロー互換を維持する。
- `signupSchema` は変更しない（`src/lib/schemas/auth.ts` を破壊しない）。

---

## 1. 実装順（依存順）

> **⚠ v0.2 からの変更点**
> - PR-05（env必須化）は PR-03 より **前** に実施する（PR-03 の `emailRedirectTo` 構築が依存するため）。
> - 既存バグ修正 PR-00a・PR-00b・PR-00c を先行させる。

1. **PR-00a** `login` アクションの `profile` null 安全化（既存バグ修正）
2. **PR-00b** `staff_invites` 整合のローカルDBドリフト事前検証（SQLチェック）
3. **PR-00c** `/api/admin/staff/invites` の招待コールバックURL整合修正（既存バグ修正）
4. **PR-05** 環境変数ガード強化（`NEXT_PUBLIC_APP_URL` 必須化）← v0.2 の 5 番目から繰り上げ
5. **PR-01** `/admin/login` のログイン専用化
6. **PR-02** `/register` 画面実装（UI + クライアント検証）
7. **PR-03** `/register/actions.ts` 実装（signUp + 安全文言 + 監査ログ）
8. **PR-04** `/register/verify` 実装（再送 + 60 秒クールダウン）
9. **PR-06** テスト追加/更新（Unit/Integration/E2E）
10. **PR-07** ドキュメント更新（運用手順・env 例）

---

## 2. PRタスク詳細

---

## PR-00a `login` アクション — `profile` null 安全化

### 目的

- メール確認後・onboarding 未完了のユーザーが `/admin/login` からログインすると、`profiles` レコードが未作成のため `!profile?.is_active` が `true` になり、即座にサインアウトされる既存バグを修正する。

### 背景（コード上の問題箇所）

`src/app/admin/actions.ts`（login 関数）:

```ts
// 現状: profile が null の場合も !profile?.is_active === true になりサインアウトされる
if (!profile?.is_active) {
  await supabase.auth.signOut();
  return { errors: { _form: [INACTIVE_ACCOUNT_MESSAGE] } };
}
```

新規登録ユーザーは `/admin/callback` → `/onboarding` の流れを経て ProfileStep でプロフィールを作成するが、途中でログアウト・再ログインしようとすると上記に引っかかる。

### 変更対象

- `src/app/admin/actions.ts`（login 関数）

### 実装ポイント

- `profile === null` の場合は「プロフィール未設定状態（onboarding 途中）」として扱い、サインアウトせず `/onboarding` へリダイレクトする。
- `profile !== null && !profile.is_active` の場合のみ INACTIVE_ACCOUNT_MESSAGE を返す。

### 完了条件

- `profiles` 未作成ユーザーがログインすると `/onboarding` に遷移する。
- `is_active = false` のユーザーは引き続き弾かれる。

### 検証

- `npm run build`
- Unit: `profile = null` のとき `/onboarding` リダイレクト、`is_active = false` のときエラー返却

---

## PR-00b `staff_invites` 整合のローカルDBドリフト事前検証（SQLチェック）

### 目的

- ローカル環境で `staff_invites` 周辺のロール制約/ポリシーが最新マイグレーション適用済みかを確認する。
- 登録機能PRに不要なマイグレーションを混在させない（1タスク1PRを維持）。

### 背景

- リポジトリ上では `20260110000300` と `20260126000100` で `staff_invites` の `clinic_admin` 整合に移行済み。
- ただしローカルDBが古い状態だと `/invite` 回帰テストが誤って失敗する。

### 変更対象

- ドキュメント（本ファイル）
- 検証SQL（運用手順へ追記）

### 実装ポイント

```sql
-- 期待値:
-- 1) staff_invites_role_check に clinic_admin が含まれる
-- 2) staff_invites_clinic_admin_select が clinic_admin を含む
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'public.staff_invites'::regclass
  AND conname = 'staff_invites_role_check';

SELECT policyname, qual
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename = 'staff_invites'
  AND policyname = 'staff_invites_clinic_admin_select';
```

### 完了条件

- 検証SQLの結果が期待値と一致する。
- 不一致がある場合は「登録機能PR」と分離した stabilization PR で対応する。

### 検証

- `supabase db push --local --dry-run`（承認が必要）
- 上記SQLの実行結果を記録

---

## PR-00c `/api/admin/staff/invites` 招待コールバックURL整合修正

### 目的

- 管理設定画面のスタッフ招待導線を、実在するコールバックルートへ統一する。

### 背景（コード上の問題箇所）

`src/app/api/admin/staff/invites/route.ts` が `redirectTo: .../auth/callback` を使用しているが、現行実装のコールバックルートは `src/app/admin/callback/route.ts` のみ。

### 変更対象

- `src/app/api/admin/staff/invites/route.ts`

### 実装ポイント

- `redirectTo` を `${NEXT_PUBLIC_APP_URL}/admin/callback?invited=true` に変更。
- `NEXT_PUBLIC_APP_URL` は `assertEnv` で参照し、フォールバックを残さない。

### 完了条件

- `/api/admin/staff/invites` から送る招待メールが実在ルートに遷移する。
- 既存 `/api/onboarding/invites` と整合する。

### 検証

- `npm run build`
- 手動: 管理設定画面からの招待メールURL確認

---

## PR-05 `NEXT_PUBLIC_APP_URL` 必須化

> **⚠ v0.2 から実施順を繰り上げ**（PR-03 の `emailRedirectTo` 構築が依存するため）

### 目的

- コールバック URL 不整合を防ぐ。PR-03 実装前に env 未設定を検知できる状態にする。

### 変更対象

- `src/lib/env.ts`

### 実装ポイント

- `REQUIRED_ENV_VARS` に `NEXT_PUBLIC_APP_URL` を追加。
- **`env` export オブジェクトにも `NEXT_PUBLIC_APP_URL` を追加する**（`assertEnv('NEXT_PUBLIC_APP_URL')` が型安全に呼べるようにするため）。

```ts
// 変更前
const REQUIRED_ENV_VARS = [
  'NEXT_PUBLIC_SUPABASE_URL',
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'SUPABASE_SERVICE_ROLE_KEY',
] as const;

export const env = {
  NEXT_PUBLIC_SUPABASE_URL: ...,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ...,
  SUPABASE_SERVICE_ROLE_KEY: ...,
} as const;

// 変更後: NEXT_PUBLIC_APP_URL を両方に追加
```

### 完了条件

- env 未設定時に fail-fast（起動時エラー）。
- `env.NEXT_PUBLIC_APP_URL` が型安全に参照できる。

### 検証

- `npm run build`（設定ありで成功）
- 任意確認: env 未設定で起動時エラー

---

## PR-01 `/admin/login` ログイン専用化

### 目的

- `src/app/admin/login/page.tsx` の `isSignUp` トグルを廃止し、ログインのみ残す。

### 変更対象

- `src/app/admin/login/page.tsx`
- 参照関数: `login`（`src/app/admin/actions.ts`）

### 実装ポイント

- `isSignUp` state・`signupState`・`signupAction`・`signup` import を削除する。
- `/register` への `<Link>` を追加する（ボタンでなくリンク要素）。
- ミドルウェアで `/register` が未認証ユーザーにアクセス可能であることを確認する。
- 認証済みユーザーの `/register` アクセス時はロールベース遷移とする（`admin/clinic_admin -> /admin`, その他 -> `/dashboard`, `clinic_id` 未設定 -> `/onboarding`）。

### 完了条件

- 新規登録導線が `/register` リンクに統一される。
- 既存ログイン（メール/パスワード）は挙動維持。
- PR-00a の修正（`profile` null 安全化）が前提として入っていること。

### 検証

- `npm run build`
- 手動: `/admin/login` から `/register` へ遷移可能

---

## PR-02 `/register` 画面実装

### 目的

- 初回登録の最小入力画面を追加（email/password/terms）。

### 変更対象

- `src/app/register/page.tsx`（新規）
- 既存参照: `getPasswordStrength`（`src/lib/schemas/auth.ts`）

### 実装ポイント

- `confirmPassword` は作らない。
- `termsAccepted` 必須（クライアントとサーバー両方で検証）。
- エラー文言は安全文言（非列挙型）。
- **パスワード強度バーの `width` 計算は `/4` ではなく `/5` を使う**。
  `getPasswordStrength()` の最大スコアは 5（条件 5 つ）だが、既存の `admin/login` 画面は `/4` で計算しており 100% 超えが起きる。新しい `/register` では修正する。
- スタッフ登録は招待制である旨の補助文言を表示する（仕様 5.1 準拠）。

### 完了条件

- 有効入力で送信可能、無効入力で即時エラー表示。
- パスワード強度バーが 0〜100% の範囲で正しく表示される。

### 検証

- `npm run build`
- 手動: バリデーション表示確認

---

## PR-03 `register` サーバーアクション

### 目的

- signUp 処理を `/admin/login` から分離し、登録専用アクション化。

### 変更対象

- `src/app/register/actions.ts`（新規）
- 参照: `sanitizeAuthInput`（`src/lib/schemas/auth.ts`）
- 参照: `AuditLogger`（`src/lib/audit-logger.ts`）
- 参照: `env`（`src/lib/env.ts`）← PR-05 完了後に `env.NEXT_PUBLIC_APP_URL` を使う

### 実装ポイント

**① アカウント列挙バグを作り込まない**
既存の `signup` アクション（`src/app/admin/actions.ts:245`）には次のバグがある：

```ts
// NG: メール登録済みかどうかを漏洩する
const errorMessage = error.message.includes('already registered')
  ? 'このメールアドレスは既に登録されています'
  : '...'
```

新しい `register/actions.ts` では **成功・失敗にかかわらず同一の安全文言** を返す。Supabase は email confirmation 有効時、重複登録でもエラーを返さず再送するだけなので、アプリ側では常に `{ success: true }` として verify 画面に遷移させれば良い。

**② `emailRedirectTo` は `NEXT_PUBLIC_APP_URL` のみ使用（フォールバック禁止）**
`env.NEXT_PUBLIC_APP_URL` を使い、`|| 'http://localhost:3000'` フォールバックを書かない。
PR-05 完了後は fail-fast が保証されているため不要。

```ts
emailRedirectTo: `${env.NEXT_PUBLIC_APP_URL}/admin/callback`
// ?next=/onboarding は不要（callback ルートが clinic_id 未設定を検知して /onboarding に誘導する）
```

**③ `AuditLogger` に `SIGNUP` イベントタイプが存在しない**
`src/lib/audit-logger.ts` の `AuditEventType` enum に `SIGNUP = 'signup'` を追加し、`logSignup()` 静的メソッドを追加する。または `AuditEventType.ADMIN_ACTION` で代替する場合はコメントで意図を明示する。

**④ レート制限の適用**
`src/lib/rate-limiting/` の既存実装を `register` アクションにも適用する。登録エンドポイントはアカウント大量作成の標的になりやすい。

**⑤ `terms_version` は定数化する**
`options.data` に保存する `terms_version` は `'v1'` をハードコードせず、定数（例: `src/lib/constants/terms.ts`）として切り出す。将来の利用規約改訂時に見つけやすくする。

### 完了条件

- 成功時に `/register/verify` 遷移用レスポンスを返す。
- 失敗時は非列挙型エラー文言のみ返す（AC-03 準拠）。
- `env.NEXT_PUBLIC_APP_URL` を使い、フォールバックなし。
- AuditLogger にイベント記録される。

### 検証

- `npm run build`
- Unit: 成功分岐（verify 遷移）、失敗分岐（非列挙型文言）、重複メール時も同一文言

---

## PR-04 `/register/verify` 実装

### 目的

- メール確認待ちの明確化と、再送導線を提供。

### 変更対象

- `src/app/register/verify/page.tsx`（新規）
- 必要なら `src/app/register/actions.ts` に再送アクション追加

### 実装ポイント

- 再送ボタンは 60 秒クールダウン。
- 再送失敗時も非列挙型文言。
- **`?email=` の URL 露出リスクを認識すること**。
  URL にメールアドレスを含めるとブラウザ履歴・サーバーアクセスログ・Referer ヘッダー経由で漏洩する可能性がある。本 PR のスコープでは受け入れるが、将来的には `sessionStorage` への変更を検討する。

### 完了条件

- `?email=` を表示し、再送が呼べる。
- クールダウン中は再送不可。

### 検証

- `npm run build`
- 手動: クールダウン動作確認

---

## PR-06 テスト整備

### 目的

- 新導線追加による回帰を防ぐ。

### 変更対象（例）

- `src/__tests__/...`（register 関連 unit/integration）
- `src/__tests__/e2e-playwright/...`（遷移 E2E）
- 既存 `/admin/login` 依存テストの期待値更新

### 必須観点

**新規フロー:**

- `/admin/login` → `/register` 遷移
- `/register` 正常系（verify 到達）
- `/admin/callback` で `clinic_id` 未設定 → `/onboarding`
- 重複メールでも安全文言（同一文言）が返ること（AC-03）

**既存フロー回帰:**

- `/invite` の signup/login 受諾フロー（PR-00b の事前検証後に実行）
- `clinic_admin` ユーザーが自テナントの招待一覧を参照できること
- `/api/admin/staff/invites` の招待メール導線（`redirectTo`）が `/admin/callback` に到達すること

**新規ユーザー境界ケース:**

- `profiles` 未作成状態のユーザーが `/admin/login` からログインすると `/onboarding` に遷移すること（PR-00a の検証）
- `is_active = false` のユーザーは引き続き弾かれること

### 検証

- `npm run test -- --ci --testPathIgnorePatterns=e2e`
- `npm run test:e2e:pw -- --project=chromium`（必要範囲）
- `npm run build`

### DoDマッピング

- DOD-11: 主要回帰テスト安定

---

## PR-07 ドキュメント更新

### 目的

- 運用時の設定ミス防止。

### 変更対象

- `docs/SETUP_VERCEL_SUPABASE.md`
- `.env.production.example`
- `.env.local.example`（または `.env.example`）← **追加**
- 必要なら `docs/operations/deployment-checklist-supabase-vercel-v0.1.md`

### 更新内容

**① 環境変数:**

- `NEXT_PUBLIC_APP_URL` を必須として明記（`.env.local.example` にも追加）。
- 初回登録導線（`/register`）を運用手順に追記。

**② MFA 暗号化鍵の設定を必須化:**
`supabase/migrations/20260218000600` の `encrypt_mfa_secret()` は、`app.settings.mfa_encryption_key` 未設定の場合に TOTP 秘密鍵を **平文で保存** する。本番稼働前に Supabase Dashboard または `supabase secrets set` で設定が必要。

```
# Supabase Database → SQL Editor で実行
ALTER DATABASE postgres
  SET "app.settings.mfa_encryption_key" = '<本番用ランダム文字列>';
```

ドキュメントにこの手順を必須として追記する。

**③ 20260218000500 マイグレーション実行前の事前確認 SQL:**
Phase 5（`clinic_id NOT NULL` 制約追加）実行前に以下の確認を必須化する。NULL 行が残っていると `UPDATE ... SET clinic_id = (最初のクリニック)` という緊急措置が走り、データが誤テナントに割り当てられる。

```sql
-- NULL件数確認（全件 0 であることを確認してから実行すること）
SELECT 'customers'        AS tbl, count(*) FROM public.customers        WHERE clinic_id IS NULL
UNION ALL
SELECT 'menus',                   count(*) FROM public.menus             WHERE clinic_id IS NULL
UNION ALL
SELECT 'resources',               count(*) FROM public.resources         WHERE clinic_id IS NULL
UNION ALL
SELECT 'reservations',            count(*) FROM public.reservations      WHERE clinic_id IS NULL
UNION ALL
SELECT 'blocks',                  count(*) FROM public.blocks            WHERE clinic_id IS NULL
UNION ALL
SELECT 'reservation_history',     count(*) FROM public.reservation_history WHERE clinic_id IS NULL;
```

### 完了条件

- 新メンバーがドキュメントだけで設定可能。
- MFA 暗号化鍵の設定手順が含まれている。
- Phase 5 マイグレーション実行手順が含まれている。

---

## 3. DoDマッピング

- DOD-06: Playwright 実行安定（baseURL/webServer整合）を維持した上で register/callback/onboarding の遷移を確認
- DOD-10: `npm run build` 安定
- DOD-11: 主要回帰テスト安定（PR-06 参照）

参照: `docs/stabilization/DoD-v0.1.md`

---

## 4. ブランチ・PR命名例

- PR-00a: `fix/login-profile-null-safety`
- PR-00b: `chore/preflight-check-staff-invites-role-alignment`
- PR-00c: `fix/admin-staff-invite-callback-path`
- PR-05: `chore/env-require-next-public-app-url`
- PR-01: `feat/register-login-page-split`
- PR-02: `feat/register-page-ui`
- PR-03: `feat/register-server-action`
- PR-04: `feat/register-verify-resend`
- PR-06: `test/register-flow-regression`
- PR-07: `docs/register-onboarding-runbook`

---

## 5. 進め方（推奨）

1. **PR-00a・PR-00b・PR-00c** で既存バグと前提整合を潰してから本実装に入る（回帰テストの土台を整える）。
2. **PR-05** で env を必須化してから PR-03 を実装する（env フォールバックの静かな失敗を防ぐ）。
3. **PR-01〜PR-03** でユーザー登録の縦スライスを完成。
4. **PR-04** で verify UX を補強。
5. **PR-06〜PR-07** で回帰耐性と運用安全性を固める。

---

## 6. 既知の未対応事項（将来タスク）

本タスクリストのスコープ外だが、コードベース精査で判明した事項を記録する。

| 項目 | 場所 | 内容 |
|------|------|------|
| `menus_select_public` 全テナント公開 | `20260218000200` | 匿名ユーザーが全テナントのメニューを参照可能。アプリ側で `clinic_id` フィルタ必須。DBレベルの保証なし |
| `decrypt_mfa_secret` 権限過剰 | `20260218000600` | TOTP 復号関数が全 `authenticated` ユーザーから呼び出し可能。`service_role` 限定を検討 |
| `.sql.backup` ファイルの混在 | `supabase/migrations/` | Supabase CLI は `.sql` のみ処理するため実害はないが、`supabase/rollbacks/` 等に移動を推奨 |
| `?email=` の URL 露出 | PR-04 | ブラウザ履歴・アクセスログ経由のメール漏洩リスク。`sessionStorage` 化を将来検討 |
| `terms_version` の定数化 | PR-03 | 利用規約改訂時の保守性のために `src/lib/constants/terms.ts` への切り出しを推奨 |
| パスワード強度スコア不整合 | `admin/login/page.tsx` | `/4` 計算だがスコア最大値は 5。既存画面の修正は本タスクスコープ外 |
