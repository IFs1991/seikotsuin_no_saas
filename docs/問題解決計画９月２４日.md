# 問題解決計画（2025年9月24日版）

この計画は `docs/non-sql-remediation-requirements.yaml` に定義された要件を実装へ落とし込むための作業指針です。個々のタスクは YAML 内の requirement ID と紐付けてあります。

## Phase 0: 前提整備（参照: OPS-006 準備）
- Supabase 環境変数の現状調査と不足確認（NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY など）。
- 監査ログ (`AuditLogger`) が想定通り出力されているかの動作確認。
- Bundle analyzer/秘密情報スキャンの方針決定とツール選定。
- Deliverable: 環境変数表、監査ログ確認メモ、ツール選定メモ。

## Phase 1: Security Baseline（target 2025-02-07）
- **Task 1.1 (SEC-001)**: `src/lib/supabase/server.ts` の共通ヘルパー化と API ルート（dashboard/revenue/staff/daily-reports/chat）からのサービスロール参照除去。RLS を前提とした認可確認を追記し、401/403 テストを追加。
- **Task 1.2 (SEC-002)**: `api/database/supabase-client` を server-only 化し、`useMasterData`, `useAdminDashboard`, `app/master-data/page.tsx` を API 経由のデータ取得にリファクタ。Bundle analyzer で秘密鍵が含まれないことを確認。
- **Task 1.3 (SEC-001/OPS-006)**: CI に RLS 迂回検知テストと秘密情報スキャンを追加。

## Phase 2: API Contract Hardening（target 2025-02-14）
- **Task 2.1 (API-003)**: `supabase gen types typescript` を導入し、`src/types/supabase.ts` を生成。`app/api/staff/route.ts`, `app/api/patients/route.ts`, `src/types/api.ts` を Supabase 定義と同期させ、DTO マッピングと Zod バリデーションを実装。Integration test で INSERT/SELECT が成功することを確認。
- **Task 2.2 (UX-004)**: ダッシュボードからモックデータフォールバックを撤廃し、エラー UI と再試行導線を追加。`useUserProfile` から取得した clinicId を使用し、API エラー時には `ApiError` を表示。

## Phase 3: Admin Tooling Readiness（target 2025-02-21）
- **Task 3.1 (ADMIN-005)**: `useMasterData` を React Query ベースの API クライアントに再設計し、`master-data-form.tsx` 他 UI を新しいシグネチャに合わせて更新。CRUD/インポート/エクスポートをテストで保証。
- **Task 3.2 (OPS-006)**: 環境変数チェックの実装、監査ログ警告の設定、CI における秘密情報スキャン実装。Ops 向け Runbook を更新。

## Phase 4: 総合検証 & ナレッジ共有（全要件横断）
- Regression テスト実行、セキュリティレビュー、bundle サイズ確認。
- 上記の結果や設定変更点をドキュメント化し、`docs/non-sql-remediation-requirements.yaml` と突き合わせて要件が満たされたことを確認。
