# セキュリティ監視運用_改善修正仕様書

## 実装ステータス: 未着手

## 目的
- セキュリティ監視運用の実装と権限・データ整合を一致させる。
- 監視メトリクス/通知の信頼性を上げ、運用時の誤動作を防ぐ。

## 前提（決定事項）
- ロールの正規名は `clinic_admin`。
- `severity_level` は `info|warning|error|critical` に統一。

## 対象範囲
- 管理API（security events/metrics/sessions/stats/notifications）
- 監視UIの `clinic_id` 取得ロジック
- `security_events` / `notifications` / `user_mfa_settings` の整合
- 既存データの正規化（severity値）

## 非対象
- E2Eテスト/fixtures/Playwright設定（別対応）
- Docker環境での実行検証

---

## 改善内容

### 1) ロール名の統一（`clinic_admin`）
#### 背景
- APIガードやRLSポリシーが `clinic_manager/manager` 前提で混在している。
- `clinic_admin` が正規ロールのため、アクセス制御が不一致になる。

#### 対応方針
- セキュリティ系APIの `allowedRoles` と `isAdmin` 判定を `admin`/`clinic_admin` に統一。
- `ensureClinicAccess` の `CROSS_CLINIC_ROLES` に `clinic_admin` を追加。
- MFA関連RLSの管理者許可ロールを `clinic_admin` に更新。

#### 変更対象ファイル（候補）
- `src/app/api/admin/security/events/route.ts`
- `src/app/api/admin/security/metrics/route.ts`
- `src/app/api/admin/security/sessions/route.ts`
- `src/app/api/admin/security/sessions/terminate/route.ts`
- `src/app/api/admin/security/stats/route.ts`
- `src/lib/supabase/guards.ts`
- 新規マイグレーション（MFA関連RLS更新）

---

### 2) `clinic_id` 取得の修正（profiles参照キー）
#### 背景
- `profiles` は `user_id` がauthユーザーID。`id` 参照だと一致しない。
- 管理画面で `clinic_id` を取得できず、監視UIがブロックされる。

#### 対応方針
- `profiles.user_id` を参照する。
- 取得失敗時は `user_permissions.staff_id` でフォールバック。
- 実装重複を避けるため、`clinic_id` 取得は共通関数に寄せる。

#### 変更対象ファイル（候補）
- `src/app/admin/(protected)/security-monitor/page.tsx`
- `src/app/admin/(protected)/security-dashboard/page.tsx`
- `src/lib/*`（共通取得ユーティリティを追加する場合）

---

### 3) セッション一覧のユーザー情報取得修正
#### 背景
- `profiles` のカラム設計とAPI参照（`id`, `first_name`, `last_name`）が不一致。
- 実運用でユーザー名が `Unknown` になりやすい。

#### 対応方針
- `profiles.user_id` で取得し、`full_name`/`email` を使用する。
- 表示名は `full_name` → `email` → `Unknown` の順でフォールバック。

#### 変更対象ファイル（候補）
- `src/app/api/admin/security/sessions/route.ts`

---

### 4) MFAメトリクス計算の正規化
#### 背景
- `profiles.mfa_enabled` は存在しない。
- MFA有効数は `user_mfa_settings.is_enabled` で判定する設計。

#### 対応方針
- 総ユーザー数は `profiles` から算出。
- MFA有効数は `user_mfa_settings` を `clinic_id` で集計。
- 既存レスポンス構造（`totalUsers`, `mfaEnabledUsers`, `mfaPercentage`）は維持。

#### 変更対象ファイル（候補）
- `src/app/api/admin/security/metrics/route.ts`

---

### 5) `severity_level` の制約強化と既存データ移行
#### 背景
- 既存データに `high/medium/low` が混在すると集計/フィルタが崩れる。

#### 対応方針
- `security_events.severity_level` に `CHECK` 制約を追加。
- 既存データを以下のルールで正規化する。
  - `high` → `error`
  - `medium` → `warning`
  - `low` → `info`

#### 変更対象ファイル（候補）
- 新規マイグレーション（`security_events` の制約とバックフィル）

---

### 6) 通知作成のベストプラクティス対応
#### 背景
- 高重要度通知が重複し得る（再送/リトライ時の二重登録）。
- 通知の参照APIがなく運用/検証がしづらい。

#### 対応方針
- `notifications` に重複防止キーを追加する。
  - 例: `(related_entity_type, related_entity_id, type)` のユニーク制約
- 通知作成は `upsert`（または `onConflict`）で冪等化。
- 管理者向け通知取得APIを追加する。
  - `GET /api/admin/notifications`
  - Query: `clinic_id`, `type`, `limit`
  - Response: 通知一覧（最新順）

#### 変更対象ファイル（候補）
- `src/app/api/admin/security/events/route.ts`
- `src/app/api/admin/notifications/route.ts`（新規）
- 新規マイグレーション（通知のユニーク制約）

---

## 受け入れ基準
- `clinic_admin` が全セキュリティ管理APIにアクセスできる。
- 監視画面で `clinic_id` を取得でき、ブロック表示にならない。
- セッション一覧に実ユーザー名（`full_name`/`email`）が表示される。
- MFAメトリクスが `user_mfa_settings` に基づいて正しく表示される。
- `severity_level` に不正値が入らず、既存データが正規化されている。
- 高重要度通知が重複せず、管理APIで取得できる。

## 補足
- E2E関連の更新は本仕様書の対象外。別仕様で対応する。
