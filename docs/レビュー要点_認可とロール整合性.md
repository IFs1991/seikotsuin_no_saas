# レビュー要点：認可とロール整合性

このドキュメントは、src 配下のレビューで判明した「認可・ロール整合性」に関する
重要ポイントを日本語で簡潔にまとめたものです。

## 主要な指摘（重要度順）

### 1. ロール文字列の不一致による認可のズレ（高）
- ミドルウェア、API、型定義でロール名の定義が一致していません。
- 例:
  - `middleware.ts` は `admin/manager`
  - `src/lib/supabase/guards.ts` は `admin/clinic_manager`
  - `src/lib/supabase/server.ts` は `admin/clinic_manager`
  - `src/types/admin.ts` は `admin/manager/therapist/receptionist` など複数系
- 結果として「UI では弾かれるが API は通る」「逆に UI は通るが API は弾かれる」など、
  予期しない挙動が起き得ます。

### 2. `allowedRoles` が厳密に効かないケース（高）
- `CROSS_CLINIC_ROLES` に含まれるロール（例: `clinic_manager`）が、
  `allowedRoles` を事実上バイパスできます。
- 例として、`allowedRoles: ['manager']` を指定した API でも
  `clinic_manager` が通過できる可能性があります。
- 結果として、意図したロール制御より広い権限が付与されます。

### 3. 停止ユーザーの API アクセスが残る可能性（中）
- ミドルウェアでは `profiles.is_active` を確認していますが、
  API の共通ガードでは `is_active` 判定がありません。
- 結果として、停止済みユーザーが API を利用できる可能性があります。

## 影響まとめ
- 認可の一貫性が崩れ、セキュリティ/運用面で想定外の権限付与やアクセス拒否が発生する。
- UI と API の挙動差が拡大し、障害の原因特定が難しくなる。

## 改善の方向性（提案）
1. ロール定義を単一のソースに集約し、DB/型/API/ミドルウェアで統一する。
2. `allowedRoles` の判定ロジックを厳密化し、例外を明示的に管理する。
3. `ensureClinicAccess` 等の共通ガードに `is_active` 判定を追加する。
