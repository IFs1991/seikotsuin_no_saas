# セキュリティ/認可/RLS 整合性 改修 要件定義書（v1）

## 1. 背景・目的
本SaaSは Next.js（App Router）+ Supabase（PostgreSQL/RLS/Auth）+ Upstash Redis（レート制限）を中核とする。一方で、API・ミドルウェア・DB RLS・ロール/テーブル定義の不整合により、以下の重大リスクが顕在化している。

- **未認証で実行可能な管理者向けAPI** が存在し、運用上の重大インシデントにつながり得る
- **MFA検証APIが本人性を担保せず**、ユーザーID指定での攻撃余地がある
- **セキュリティログ（CSP違反等）の参照/更新が未認証**である、またはDB側RLSと噛み合わず「保存できない/見えるべき人が見えない」状態が起き得る
- **ロール/テナント境界がコードとDBで分裂**（`profiles`/`user_permissions`/`clinic_users`、`admin|manager|clinic_manager|clinic_admin`混在）しており、RLSの効力が担保できない
- **PII/追跡情報をレスポンスヘッダーでクライアントへ露出**している

本要件定義書は、上記リスクを解消し「認可境界を単一化し、二重チェック可能な状態」にすることを目的とする。

## 2. スコープ
### 2.1 対象
- Next.js API routes（`src/app/api/**`）の認証・認可・入力検証・監査ログ
- Next Middleware（`middleware.ts`）の認証/セッション更新方式とヘッダー出力
- Supabase DB（RLS/ポリシー/関数/テーブル参照）の整合性（主にセキュリティ系・管理系）
- ロール/権限/テナント境界（clinic_id）の単一化

### 2.2 非対象（現フェーズではやらない）
- 画面/UXの改善、分析指標の正しさ改善（別チケット）
- 認証方式の全面刷新（例: NextAuth導入/移行）
- 既存データの大規模マイグレーション（必要最小限の修正に留める）

## 3. 現状課題（事実ベース）
※具体例（代表）。全量は後述の棚卸しで確定する。

- 未認証の管理者系API: `src/app/api/admin/rate-limit/*`、`src/app/api/admin/security/csp-violations` 等
- MFA検証が本人性を担保しない: `src/app/api/mfa/verify/route.ts` は `userId` をリクエストボディで受ける
- ミドルウェアが `X-User-ID`/`X-Client-IP` 等をレスポンスヘッダーへ付与している: `middleware.ts`
- DB側RLS/ポリシーが `clinic_users` 前提の箇所がある一方、アプリ側は `profiles`/`user_permissions` を参照している（参照元の不整合）

## 4. あるべき方針（設計原則）
### 4.1 認可の単一ソース
- **テナント境界（clinic_id）とロール（role）を、単一の“権限ソース”に統一**する
  - 推奨: `profiles`（`user_id`, `clinic_id`, `role`, `is_active`）を一次ソースにする
  - `user_permissions` を残す場合でも「どちらが一次か」を明記し、両者の差分が“発生しない/検知できる”設計にする

### 4.2 デフォルト拒否
- APIは **未認証をデフォルト拒否**。例外は明示（例: `/api/health`, CSP report 等）。
- DBは **RLS有効化 + 既定拒否**。例外は最小に。

### 4.3 二重チェック（App層 + DB層）
- App層: `processApiRequest()` / `ensureClinicAccess()` を必須化（役割・clinic境界・監査ログ）
- DB層: RLSでclinic境界とロール境界を強制（App層のバグでも越境しない）

### 4.4 PII最小化
- クライアントへ返すヘッダー/レスポンスから、ユーザーID/IP等の **不要なPIIを排除**する
- 必要ならサーバー側構造化ログへ集約（監査/追跡はサーバー側で完結）

## 5. 要件（Must/Should）

### 5.1 API認証・認可（Must）
1. **管理者配下 API（`/api/admin/**`）は全て認証必須**
   - 例外なし（`/api/health` は管理配下でない）
2. `processApiRequest()` を標準ガードとし、以下を必須とする
   - `allowedRoles` の明示（管理者系は最低でも `admin`, `clinic_manager`）
   - `clinicId`/`requireClinicMatch` のポリシー統一（“指定があるなら一致必須”を原則）
3. 未認証/権限不足時は、統一レスポンス（`createErrorResponse`）で返却し、監査ログに記録する

### 5.2 MFA検証（Must）
1. `/api/mfa/verify` は **リクエストボディから `userId` を受け取らない**
   - サーバー側で `supabase.auth.getUser()` により本人を確定する
2. MFA検証は **レート制限（ユーザーID + IP）** を必須化し、セキュリティイベント/監査ログを記録する
3. 失敗理由の過度な開示を避ける（攻撃者にヒントを与えない）

### 5.3 セキュリティログ（CSP等）（Must）
1. `csp-violations` / `csp-stats` 等の閲覧・更新は **管理者のみ**（API層で認可）
2. CSPレポート受信（`/api/security/csp-report`）は以下いずれかで **“確実に保存できる”** こと
   - A案: DB側で **匿名INSERTのみ許可**（参照/更新は管理者のみ）
   - B案: API側で **service role** を用いてINSERT（DB側は管理者閲覧のみ）
   - どちらを採用するかは「漏えいリスク」「運用」「Supabase Key管理」を踏まえ設計決定する
3. CSP報告はスパム対策として既存のレート制限を維持し、保存失敗時のフォールバック（構造化ログ）を持つ

### 5.4 ミドルウェア（Must）
1. Next Middleware から **PII/追跡ヘッダーを外部へ返さない**
2. ミドルウェアで Supabase セッション更新を行う場合、**ミドルウェア実行環境（Edge/Node）に整合するクライアント**を使用する
3. CSP付与は **1箇所に集約**（`next.config.js` と `middleware.ts` の二重適用を避ける）

### 5.5 DB（RLS/ロール/参照整合）（Must）
1. DB側の認可参照（`clinic_users` 等）がある場合、**アプリの一次ソースに合わせて統一**
2. ロール名を **1セットに正規化**し、アプリ/DB双方で同じ語彙を使う（例: `admin`, `manager`, `clinic_manager`, `staff` 等）
3. テナント境界は `clinic_id` で統一し、`NULL` を許すテーブル（グローバル設定等）は例外ルールを明記する

### 5.6 監査・運用（Should）
1. 重要操作（管理系API、MFA、権限拒否）を `audit_logs`/`security_events` に記録する
2. 失敗時でも本線処理を極力落とさない（ログ記録失敗はフォールバック）

## 6. 受け入れ条件（Acceptance Criteria）
### 6.1 セキュリティ（必達）
- 未認証で `/api/admin/**` を叩くと **401**（または統一仕様の拒否）になる
- 権限不足で `/api/admin/**` を叩くと **403** になり、監査ログが残る
- `/api/mfa/verify` は本人以外の検証ができない（`userId` 受け取り廃止）
- クライアントレスポンスに `X-User-ID`/`X-Client-IP` 等のPIIヘッダーが出ない
- CSP report が保存され、保存失敗は構造化ログに残る

### 6.2 整合性（必達）
- ロール定義がアプリ/DBで一致し、RLS関数・ポリシーが同じ参照元を使う
- 「clinic指定あり/なし」の挙動がAPI間で一貫（越境や意図せぬ全件取得がない）

### 6.3 回帰（必須）
- 既存の主要画面/API（ダッシュボード/日報/患者/収益/スタッフ）が、正当ユーザーで動作する

## 7. 実装タスク（ドラフト）
1. API棚卸し: `src/app/api/**/route.ts` を列挙し、認証方式を分類（必須/匿名例外）
2. ガード統一: `/api/admin/**` と `csp-*`、`rate-limit`、`tables` 等へ `processApiRequest()` を適用
3. MFA: `/api/mfa/verify` の仕様変更（本人確定、レート制限、監査）
4. ミドルウェア: PIIヘッダー削除、Supabaseミドルウェアクライアントの整合、CSP付与の一本化
5. DB: `clinic_users` 参照の排除または整備、RLSポリシーの整合（CSP保存方式決定に合わせる）
6. 回帰テスト: 管理APIの401/403、MFA本人性、CSP保存、主要APIの正常系

## 8. ロールアウト方針（推奨）
- まず **管理系APIの認証必須化（P0）** を先にリリース（影響範囲が明確で安全）
- 次に **MFA本人性** と **CSPログ保存/閲覧** を適用
- 最後に **DB側の整合（RLS/ロール/参照統一）** を段階的に（migration・データ差分の検知を入れつつ）

## 9. ダブルチェック（レビュー観点）
### 9.1 セキュリティ観点
- [ ] `/api/admin/**` に匿名アクセスできる経路が残っていない
- [ ] `processApiRequest()`/`ensureClinicAccess()` の `allowedRoles` 未設定がない
- [ ] 「clinic_id未指定」で全件取得になっていない（管理者以外で）
- [ ] MFA検証が `userId` 指定になっていない
- [ ] PIIがレスポンスヘッダー/JSONに不要に含まれていない

### 9.2 運用観点
- [ ] ログ（監査/セキュリティ）が“失敗しても本線を止めない”設計になっている
- [ ] 例外系で秘匿情報（鍵/トークン）がログに出ない
- [ ] CSP report のスパム対策（レート制限/サイズ制限/保存失敗時の扱い）がある

### 9.3 整合性観点
- [ ] ロール名がアプリ/DBで一致している
- [ ] DB側関数/ポリシーが参照するテーブル（`profiles` 等）が一次ソースとして明確
- [ ] 例外（グローバル設定等）の扱いがドキュメント化されている

## 10. 実行環境に関する注意（検証制約）
本リポジトリに対する自動修正・レビューは、実行環境（CI/ローカル/エージェント）の差異により **Node.js/npm コマンドが実行できない場合がある**。

### 10.1 制約の例
- `npm test` / `npm run type-check` 等が、Node.js 実行環境の解決失敗により実行できないことがある

### 10.2 要求事項（運用）
- 自動テストが実行できない環境での修正は、**静的ダブルチェック（ガード適用漏れ、`userId`受け取り残存、PIIヘッダー残存など）** を必ず実施し、結果を記録する
- 最終的な受け入れ判定は、**Node.js/npm が正常に動作するローカル環境またはCI** で以下を実行して行う
  - `npm run type-check`
  - `npm test`
