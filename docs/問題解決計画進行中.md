# 問題解決計画進行中メモ（2025-09-24版）

## 進行状況サマリー
- **API-003**: 患者・スタッフ API を Zod DTO + Supabase 型に合わせて再実装。`app/api/patients/route.ts` と `app/api/staff/route.ts` はセッションスコープの Supabase クライアントを使用し、`schema.ts` で入力検証と DB 行マッピングを集中管理。スキーマ単体テスト（`src/__tests__/api/patient-schema.test.ts` / `staff-schema.test.ts`）を追加済み。
- **OPS-006**: ランタイム環境変数チェックを追加（`src/lib/env.ts` 経由で必須変数を検証）。未設定時は本番起動を即座に失敗させる。`npm run scan:secrets` で `SUPABASE_SERVICE_ROLE_KEY` のリークを検出できるようにし、AuditLogger には不正アクセス時の警告ログを追加。
- **セキュリティ基盤（SEC-001/002）**: 既にセッションスコープ化済み。今回の変更で API 層の型整合性が強化され、管理 UI も新 API クライアントへ移行済み。

## 未解決タスク / 次回アクション
- `supabase gen types typescript` を CI で実行できるよう `npm run supabase:types` を追加。プロジェクト ID/アクセストークンを取得後、実行して `src/types/supabase.ts` を最新化する。
- 既存テスト群に未修正の TypeScript エラーが多数残存（既存コード由来）。書き込み可能な環境で `npm run type-check` と `npm test` を再実行し、段階的に解消する。
- `npm run scan:secrets` を CI パイプラインへ組み込み、bundle 前に秘匿情報を検出できるよう設定する。

## 実行済みコマンド（参考）
- `NEXT_DISABLE_SWC_DOWNLOAD=1 npm test -- src/__tests__/api/patient-schema.test.ts src/__tests__/api/staff-schema.test.ts` → 読み取り専用環境のため `node_modules/next/next-swc-fallback` 作成に失敗。書込み可能な環境で再実行が必要。
- `npm run type-check` → `tsconfig.tsbuildinfo` 書込み不可、および既存モジュール起因の型エラー多数。タイプ修正とビルドキャッシュ書込み許可後に再試行。

## 追加メモ
- 管理ダッシュボード API を新設し、React Query ベースの admin hooks が認証済みエンドポイントを利用するよう移行済み。
- README に必須環境変数と保守スクリプト（`supabase:types` / `scan:secrets`）を追記済み。

