# 優先順で具体的な実装タスクリスト（MVP→本番強化）

本ドキュメントは、MVPから本番運用へ向けての実装タスクを優先度順に整理したものです。各タスクは目的・手順・完了基準（DoD）を明記しています。

## 高優先（0–2週間）

- [ ] RLS仕上げと検証（必須）
  - 目的: 多テナント分離を厳密化し、誤露出リスクを排除する。
  - 手順:
    - [ ] `src/api/database/rls-policies.sql` の未定義参照を解消
      - 選択肢A: `therapist_patient_assignments` テーブルを追加（簡易定義: therapist_id, patient_id, clinic_id, is_active）
      - 選択肢B: 当該参照部分を一旦コメントアウトし、将来の担当者機能導入時に復活
    - [ ] `security_policy_status` ビューを作成（ポリシー有効状況の可視化用）
    - [ ] Supabaseに適用 → `validate_rls.sql` 実行でポリシー/関数/インデックス/監査の健全性を確認
  - DoD:
    - `validate_rls.sql` の「final_status」がRLS実装完了（A級/B級）である
    - 認証ユーザで他院データが参照できない（手動E2Eで拒否系確認）

- [ ] 監視・アラートの最小セット（必須）
  - 目的: 障害の早期検知と一次切り分けを可能にする。
  - 手順:
    - [ ] Vercel: Log Drain/Alerts設定（エラー閾値で通知）
    - [ ] Supabase: プロジェクトのモニタリングメトリクス（CPU/コネクション/エラー率）＋ログクエリの保存
    - [ ] Slack Webhook or Opsメールで通知連携（`.env.production`にURL）
    - [ ] Sentry等のAPM/エラートラッキング導入（`SENTRY_DSN`）
  - DoD:
    - 意図的な例外でSlack/メール通知が届く
    - ダッシュボードで直近エラー率/レスポンス遅延が確認できる

- [ ] 最小E2Eテスト（必須）
  - 目的: 主要導線を自動で守る（退行検知）。
  - 手順（Playwright想定）:
    - [ ] シナリオ1: ログイン → `/patients` 実データ表示（認証必須ルート）
    - [ ] シナリオ2: `/daily-reports/input` で保存 → `/daily-reports` に反映
    - [ ] シナリオ3: `/revenue` でサマリ/ランキングが表示
    - [ ] CIに統合（`/.github/workflows/ci.yml` へ追加ジョブ）
  - DoD:
    - ローカル/CIで3シナリオが安定パス（フレーク率 < 5%）

- [ ] 親テナント管理UI（最小）（必須）
  - 目的: グループ管理者が子テナント（クリニック）とユーザ権限を運用できる。
  - 手順:
    - [ ] `/admin/tenants` で `clinics` 一覧/作成/編集/無効化（Server Actions or Route Handlers）
    - [ ] `/admin/users` で `user_permissions` の作成/権限変更（`admin/clinic_manager/therapist`）
    - [ ] 新規クリニック作成時に `NEXT_PUBLIC_DEFAULT_CLINIC_ID` へ反映できる運用ガイド記載
  - DoD:
    - adminでログイン時、上記2画面が機能し、DBに反映
    - 非adminではアクセス拒否（RLSとUIガードの両方）

- [ ] バックアップ/鍵ローテのRunbook（必須）
  - 目的: インシデント時の復旧と秘密情報管理の標準化。
  - 手順:
    - [ ] Supabaseのバックアップ/Point-in-time Recovery方針を決定しRunbook化（`docs/runbooks/backup-restore.md`）
    - [ ] `ENCRYPTION_KEY`/`NEXTAUTH_SECRET`/各APIキーのローテ手順（影響範囲/ダウンタイム/検証方法）を記載
  - DoD:
    - 手順を第三者が実施しても復旧/ローテが完了するレベルで明文化

## 中優先（2–4週間）

- [ ] レート制限/CSRF/ボット対策（推奨）
  - 目的: API乱用やCSRFによる攻撃面を縮小。
  - 手順:
    - [ ] `middleware.ts` またはAPIハンドラでレート制限（Upstash Redis等）
    - [ ] 重要POSTにCSRFトークン/Originチェックを追加
    - [ ] 基本的なUser-Agent/Robots対策
  - DoD:
    - ストレステストでスロットリングが機能し、誤検知は最小限

- [ ] データ保護（暗号化/PII制御）（推奨）
  - 目的: PII保護と鍵管理の妥当化。
  - 手順:
    - [ ] `schema.sql` の `encrypt_*`/`decrypt_*` の実運用化（KMS/Secret Manager運用を前提）
    - [ ] PII列（電話/住所等）の保存/マスキング方針と閲覧ロールの整理
  - DoD:
    - キーの保管/ローテ/監査ログが一貫した手順で運用できる

- [ ] メータリング基盤（将来の課金/利用分析）（推奨）
  - 目的: テナント単位の利用可視化（将来の課金/社内コスト配賦に備える）。
  - 手順:
    - [ ] `usage_events` テーブル作成（tenant_id, user_id, event_type, payload, created_at）
    - [ ] 主要アクションでイベント発火（API層またはServer Actions）
    - [ ] 月次集計ビュー/関数を作成
  - DoD:
    - クリニック別に月次イベント件数/主要KPIが可視化できる

- [ ] パフォーマンス/コスト最適化（推奨）
  - 目的: UXと運用コストのバランス改善。
  - 手順:
    - [ ] 主要クエリのEXPLAIN/インデックス点検（`daily_revenue_summary`/RPC含む）
    - [ ] Next.jsの計測（Instrumentation）と画像/キャッシュ戦略の見直し
  - DoD:
    - TTFB/P95レスポンス/DBクエリ時間の改善が確認できる

- [ ] マイグレーション運用整備（推奨）
  - 目的: スキーマ変更の安全な運用。
  - 手順:
    - [ ] `sql/migrations/` へ段階的SQLを蓄積（シードとは別管理）
    - [ ] 適用スクリプト（`scripts/apply_migrations.sh`）とロールバック方針を明文化
  - DoD:
    - 新旧環境で順/逆適用が再現可能

## 後回し/任意（4週間以降）

- [ ] グラフ/可視化強化（Recharts/Visx など）
- [ ] エラーメッセージ/文言の国際化（i18n）
- [ ] 権限モデルの細分化（監査ビュー/限定公開リンク 等）
- [ ] AIコメントの実API連携（Gemini等）とプロンプト管理

## 依存関係・参照

- RLS/SQL: `src/api/database/schema.sql`, `src/api/database/functions.sql`, `src/api/database/rls-policies.sql`, `validate_rls.sql`
- Seed: `sql/seeds/0001_*`〜`0004_*`
- ドキュメント: `SQLの配置場所.md`, `docs/fe-be-alignment-plan.md`, `docs/github-publish-plan.md`
- CI: `/.github/workflows/ci.yml`

## 備考

- すべてのタスクは、PR→CI→レビュー→デプロイのフローで進める。
- セキュリティ影響がある変更（RLS/鍵/暗号化）は必ずRunbook更新とセットで対応する。
