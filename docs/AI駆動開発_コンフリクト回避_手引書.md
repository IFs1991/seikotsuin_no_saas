# AI駆動開発_コンフリクト回避_手引書

## 目的
- AIエージェントが並行で作業しても、API契約やデータ構造の衝突を起こさない。
- 仕様書に基づく一貫した実装・テストを保証する。

## 基本ルール
1. **API契約は固定**: 変更が必要な場合は「契約変更PR」として分離。
2. **DBスキーマ変更は最小化**: 変更時はマイグレーションとE2Eシード更新を同時に行う。
3. **UI変更はAPIに追随**: APIとUIを同時に変更しない（先にAPI、次にUI）。
4. **同一ファイル同時編集禁止**: 担当範囲はファイル単位で分離する。

## 実装フロー（推奨）
1. 仕様書の「E2Eテスト仕様」を確認
2. 先にE2E/ユニットテストを追加（fail-first）
3. API → UI → テストの順で実装
4. E2Eで通過を確認

## 競合回避の具体策
- **API契約の固定化**
  - 型定義 (`src/types/api.ts`) の変更は最小限にし、変更時は明文化。
- **DBスキーマの固定化**
  - `clinic_settings` や `security_events` のカテゴリ/列名は変更禁止。
- **UI依存の分離**
  - UIコンポーネントは、APIから受け取ったデータを変換して描画するだけに留める。

## E2Eテストの運用ルール
- すべてのE2Eは Playwright を標準とする。
- すべてのE2Eは `E2E共通フィクスチャ仕様書` を前提にする。
- テストケースは1シナリオ1テストを原則とする。
- 失敗時は「データ不足」「権限不足」「UI待機不足」のいずれかを疑う。

## 役割分担の例
- **API担当**: ルート追加/更新、スキーマ/バリデーション
- **UI担当**: 画面実装、空状態/エラー表示
- **テスト担当**: ユニット/E2Eの追加・整備

## AIへの指示テンプレ
- 目的: 仕様書のどこを実装するか
- 制約: 変更禁止のAPI/DB契約
- 範囲: 変更対象ファイル
- テスト: 追加するE2E/ユニット

## 例
- 「`docs/管理設定永続化_MVP仕様書.md` を実装。`clinic_settings` のカテゴリは変更しない。APIとUIを分離して実装し、E2Eシナリオ1〜3を追加」

## 更新フロー
- 仕様書を更新した場合、必ず以下も更新する:
  - E2E共通フィクスチャ仕様書
  - 関連するテストケース

## 参考
- `docs/E2E共通フィクスチャ仕様書.md`
- `docs/Playwright_E2E手引書.md`
