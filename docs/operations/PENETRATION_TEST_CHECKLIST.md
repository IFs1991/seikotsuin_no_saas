# ペネトレーションテストチェックリスト
**Phase 3 M3: セキュリティ検証チェックリスト**

## 概要
本チェックリストは整骨院管理SaaSのセキュリティペネトレーションテスト実施時に使用します。

---

## 1. 認証・認可テスト

### 1.1 認証バイパス
- [ ] ログイン画面で SQLインジェクション試行
- [ ] パスワード総当たり攻撃（5回失敗でロック確認）
- [ ] セッショントークン推測攻撃
- [ ] JWT改ざん試行（署名検証確認）
- [ ] 期限切れトークンでのアクセス試行

### 1.2 認可制御
- [ ] 他ユーザーのデータ直接アクセス試行（RLS確認）
- [ ] API endpoint の権限チェック
- [ ] クリニックID改ざんによるデータアクセス試行
- [ ] 管理者機能への一般ユーザーアクセス試行

**検証ツール**: Burp Suite, OWASP ZAP

---

## 2. インジェクション攻撃

### 2.1 SQLインジェクション
- [ ] ログインフォームに `' OR 1=1--` 入力
- [ ] 検索フィールドに `'; DROP TABLE users--` 入力
- [ ] Prepared Statement 使用確認（SupabaseクライアントSDK）

### 2.2 XSS（クロスサイトスクリプティング）
- [ ] 日報入力フィールドに `<script>alert('XSS')</script>` 入力
- [ ] CSP違反アラート生成確認
- [ ] DOMPurify サニタイゼーション動作確認
- [ ] Stored XSS: データベース保存後の表示確認

### 2.3 コマンドインジェクション
- [ ] ファイルアップロード機能（未実装の場合スキップ）
- [ ] 外部APIパラメータ改ざん試行

**検証ツール**: OWASP ZAP, XSStrike

---

## 3. セッション管理

### 3.1 セッション固定化攻撃
- [ ] ログイン前後のセッションID変化確認
- [ ] 他のブラウザで同一セッションIDアクセス試行
- [ ] 複数デバイスログイン制限確認

### 3.2 セッションハイジャック
- [ ] セッショントークンのHTTPSのみ送信確認
- [ ] セッション有効期限テスト（アイドル30分 / 絶対8時間）
- [ ] IP/User-Agent変化検知テスト
- [ ] SecurityMonitor異常検知確認

### 3.3 CSRF（クロスサイトリクエストフォージェリ）
- [ ] CSRFトークン存在確認
- [ ] SameSite Cookie属性確認
- [ ] POST/PUT/DELETE リクエストのトークン検証

**検証ツール**: Burp Suite CSRF PoC Generator

---

## 4. 暗号化・通信セキュリティ

### 4.1 TLS/SSL
- [ ] HTTP接続の強制HTTPS リダイレクト確認
- [ ] TLS 1.2以上使用確認
- [ ] 証明書有効性確認
- [ ] HSTS ヘッダー存在確認

### 4.2 環境変数・秘密情報
- [ ] `scan:secrets` 実行結果確認（CI統合済み）
- [ ] ブラウザDevToolsで秘密鍵漏洩チェック
- [ ] Service Role Key のクライアント露出チェック
- [ ] ソースマップの本番環境無効化確認

**検証ツール**: SSL Labs, testssl.sh

---

## 5. データ保護

### 5.1 個人情報保護
- [ ] 患者情報の暗号化確認（Supabase at-rest encryption）
- [ ] 監査ログに機密情報が平文で記録されていないか
- [ ] GDPR/個人情報保護法準拠確認

### 5.2 Row Level Security (RLS)
- [ ] Supabase RLSポリシー有効化確認
- [ ] クリニック間データ分離テスト
- [ ] ユーザーロール別アクセス制御テスト

**検証SQLクエリ**:
```sql
-- RLSポリシー確認
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies
WHERE schemaname = 'public';
```

---

## 6. アプリケーションロジック

### 6.1 ビジネスロジック
- [ ] 負の数値入力（日報の患者数に-1など）
- [ ] 異常に大きい数値入力
- [ ] 日付の前後矛盾（未来日付の日報登録）
- [ ] 重複登録防止確認

### 6.2 レート制限
- [ ] API エンドポイントのレート制限確認
- [ ] ログイン試行回数制限（5回/15分）
- [ ] CSP違反レポートのレート制限

**検証ツール**: Apache JMeter, Locust

---

## 7. エラーハンドリング

### 7.1 情報漏洩
- [ ] エラーメッセージにスタックトレース非表示確認
- [ ] 本番環境でデバッグ情報非表示確認
- [ ] 404/500エラーページのカスタマイズ確認

### 7.2 例外処理
- [ ] 予期しない入力に対する適切なエラー応答
- [ ] データベースエラー時のフォールバック動作
- [ ] 監査ログフォールバック動作確認

---

## 8. 依存関係・サプライチェーン

### 8.1 脆弱性スキャン
- [ ] `npm audit` 実行結果確認
- [ ] Critical/High脆弱性ゼロ確認
- [ ] 依存パッケージ更新計画策定

### 8.2 サードパーティ統合
- [ ] Supabase SDKバージョン確認
- [ ] Next.js/Reactバージョン確認
- [ ] セキュリティパッチ適用状況確認

**検証コマンド**:
```bash
npm audit --production
npm outdated
```

---

## 9. インフラストラクチャ

### 9.1 Vercel設定
- [ ] 環境変数の暗号化確認
- [ ] プレビューデプロイの本番データアクセス制限
- [ ] ログ保持期間設定

### 9.2 Supabase設定
- [ ] データベースバックアップ有効化
- [ ] ポイントインタイムリカバリ設定
- [ ] ネットワークポリシー確認

---

## 10. 監視・インシデント対応

### 10.1 ログ監視
- [ ] 監査ログの異常検知アラート設定
- [ ] SecurityMonitor のアラート動作確認
- [ ] ログ改ざん検知メカニズム（TODO: 将来実装）

### 10.2 インシデント対応
- [ ] Runbook 実在確認
- [ ] オンコール体制構築確認
- [ ] ロールバック手順のドライラン実施

---

## 11. コンプライアンス

### 11.1 医療機関向け要件
- [ ] 個人情報保護法準拠
- [ ] 監査証跡の7年保存計画
- [ ] アクセス権限管理ドキュメント整備

### 11.2 セキュリティポリシー
- [ ] 環境変数管理ポリシー準拠（ENV_MANAGEMENT_POLICY.md）
- [ ] パスワードポリシー実装（最小8文字・複雑性要件）
- [ ] セッションタイムアウトポリシー適用

---

## 12. ペネトレーションテスト実施記録

### 実施情報
- **実施日**: YYYY-MM-DD
- **実施者**: [氏名・所属]
- **対象環境**: Staging / Production
- **使用ツール**: Burp Suite Pro, OWASP ZAP, nmap, etc.

### 発見事項サマリ

| 重大度 | 件数 | 詳細 |
|--------|------|------|
| Critical | 0 | - |
| High | 0 | - |
| Medium | 0 | - |
| Low | 0 | - |
| Info | 0 | - |

### 対応状況
- [ ] すべてのCritical/High脆弱性を修正済み
- [ ] Medium脆弱性の修正計画策定済み
- [ ] ポストモーテム作成完了

---

## 関連ドキュメント
- [環境変数管理ポリシー](./ENV_MANAGEMENT_POLICY.md)
- [Runbook](./RUNBOOK.md)
- [監査ログ検証レポート](./AUDIT_LOG_VERIFICATION.md)

## 更新履歴
| 日付 | 変更内容 | 担当者 |
|------|----------|--------|
| 2025-10-03 | 初版作成（M3実装） | Security Lead |
