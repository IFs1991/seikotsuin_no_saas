# 将来実装案（ユニーク性・構想・叩き台）

本ドキュメントは、整骨院グループ向け多テナントSaaSの将来実装方針を端的にまとめたものです。親テナント（本部）による子テナント（各院）管理を前提に、集客→予約→シフト→施術→決済・請求→分析→打ち手の閉ループを狙います。

## 要約（ユニーク度）

- 現状: 中〜高（6.5/10）。RLSで安全に「日報→分析→AIコメント」まで回る縦特化が強み。
- 将来: 高（8.5/10）。Hot Pepper連携・決済・契約・シフトを繋ぎ、運営/財務/マーケのKPIを一枚で回す閉ループがモートに。

## 差別化ポイント（現状）

- 多テナント/RLS: クリニック単位で厳密分離、本部は横断分析可能。
- ドメインKPI: LTV/離脱/メニュー別収益など業態に直結する指標。
- 運用土台: 監査ログ・CSP・CI・Seedが短期MVPとして十分。

## 将来機能と価値

- 患者決済（施術現場/オンライン）
  - 施術→決済→売上集計の自動連携。現場負担と突合ミス削減。
- 有料プラン契約（テナント課金）
  - 店舗数/座席/機能/利用量に応じた課金。価値と収益が直結。
- Hot Pepper Beauty連動（集客の合流）
  - 外部予約→内部KPIに合流し、広告ROI/LTV/再診を可視化。
- HR一括シフト管理（本部視点）
  - 予測来院×スキル×制約で配置最適化。人時売上と満足度を両立。

## 実装アーキテクチャ（叩き台）

- 決済
  - プロバイダ: Stripe（オンライン/Terminal）、Square、PayPay/LINE Pay併用可。
  - データ: `payments(id, clinic_id, visit_id, patient_id, amount, method, status, captured_at)` → `revenues`と自動突合。領収書/インボイス、税対応。
- プラン/課金
  - Stripe Billingでプラン/アドオン（店舗数・座席・API）。
  - テーブル: `tenants(親=HQ, 子=clinics)`, `subscriptions`, `usage_events`（メータリング）。
  - 機能ゲート: Feature Flags（例: 連携/最適化はPro以上）。
- Hot Pepper連携
  - 公式API/パートナー連携（代替: iCal/メール取込、Zapier/Make）。
  - 取込: `external_bookings`→重複除去→`visits`へ。患者突合は電話/メール/氏名+誕生日の確率マッチ。
- HRシフト
  - テーブル: `staff_shifts`, `shift_requests`, `constraints(資格/休暇/勤務間隔)`。
  - ロジック: 需要予測（`get_hourly_visit_pattern`等）×スキルで半自動割当→承認フロー。
- テナント管理
  - 親テナント（role=admin）が子テナント（clinics）作成/編集/無効化、ユーザ権限（`user_permissions`）管理。

## 競合・リスク・モート

- 競合: サロンPOS/予約（Hot Pepper/Reservia/Air等）＋汎用BI/会計の組合せ。
- リスク: 医療系PIIの保護（鍵/暗号化/監査）、外部APIの規約/安定、RLS複雑化、決済/広告の突合誤差。
- モート: ①チェーン横断データ基盤 ②需要予測×シフト最適の精度 ③広告ROIとLTVを接続する改善ループ。

## 短期のユニーク度最大化（優先順）

1. 本部UIで子テナント運用（作成/権限/請求）を最小実装し「チェーン運用の芯」を提示。
2. 予約（Hot Pepper）→来院→決済→売上→ダッシュボードの最短経路を1〜2院でPoC。
3. メータリング/プラン課金のスケルトン導入（`usage_events`＋Feature Flags）。
4. シフト推奨の簡易版（警告/推奨）でAIの運用価値を可視化。
5. 監査/暗号化の仕上げで「医療データでも安心」を明示（日本向け準拠の記載）。

## ラフなマイルストーン

- Phase A（0–4週）: 親テナントUI最小、予約→決済→売上PoC、RLS最終化、E2E最小。
- Phase B（4–8週）: 課金/メータリングの骨格、シフト推奨β、広告ROI×LTVダッシュボード。
- Phase C（8–12週）: 決済/外部連携の本実装、運用ガード（監視/Runbook）強化、権限モデル拡張。

## まとめ

- 本SaaSは「集客〜オペ〜決済〜分析」を縦に統合することで、施策→効果検証のサイクルを短縮し、チェーン運営の実効改善を生む設計。まずは最小ループの実装で、予約充足率↑/人時売上↑/離脱↓などの改善インパクトを数値で示すのが勝ち筋。
